<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root {
      --primary-color: #FFD700; /* Gold */
      --background-color: #1a1a1a; /* Dark background */
      --card-color: #2c2c2c; /* Dark card */
      --text-color: #ffffff; /* White text */
      --text-secondary: #aaaaaa; /* Gray text */
      --border-color: #444444;
      --success-color: #4CAF50;
      --error-color: #F44336;
      --warning-color: #FF9800;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .card {
      background-color: var(--card-color);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .logo {
      width: 60px;
      height: 60px;
      margin-right: 15px;
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .title-area {
      flex: 1;
    }
    h1 {
      margin: 0;
      color: var(--primary-color);
      font-size: 24px;
    }
    .subtitle {
      color: var(--text-secondary);
      font-size: 16px;
      margin-top: 5px;
    }
    .machine-id {
      color: var(--primary-color);
      font-size: 14px;
      margin-top: 5px;
      font-weight: bold;
    }
    h2 {
      color: var(--primary-color);
      border-bottom: 1px solid var(--primary-color);
      padding-bottom: 5px;
      margin-top: 25px;
    }
    h3 {
      color: var(--primary-color);
      margin-top: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      color: var(--text-secondary);
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: #3a3a3a;
      color: var(--text-color);
      font-size: 14px;
    }
    button {
      padding: 12px 20px;
      background-color: var(--primary-color);
      color: #000000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: opacity 0.3s;
    }
    button:hover {
      opacity: 0.8;
    }
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .btn-group button {
      flex: 1;
    }
    .btn-secondary {
      background-color: #555;
      color: white;
    }
    .btn-danger {
      background-color: var(--error-color);
      color: white;
    }
    #status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      display: none;
      text-align: center;
    }
    .success { background-color: var(--success-color); color: white; }
    .error { background-color: var(--error-color); color: white; }
    .info { background-color: #2196F3; color: white; }
    .warning { background-color: var(--warning-color); color: white; }
    .hidden { display: none; }
    .row { display: flex; gap: 20px; }
    .col { flex: 1; }
    
    /* Navigation Styles */
    .nav-container {
      display: flex;
      margin-bottom: 20px;
      position: relative;
      z-index: 100;
    }
    .nav-categories {
      width: 200px;
      border-right: 1px solid var(--border-color);
      padding-right: 15px;
    }
    .nav-category {
      padding: 10px;
      cursor: pointer !important;
      border-radius: 4px;
      margin-bottom: 5px;
      transition: all 0.3s;
      position: relative;
      z-index: 20;
      user-select: none;
      pointer-events: auto !important;
    }
    .nav-category:hover {
      background-color: rgba(255, 215, 0, 0.1);
    }
    .nav-category.active {
      background-color: rgba(255, 215, 0, 0.2);
      font-weight: bold;
    }
    .nav-tabs {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 10px;
      padding-left: 15px;
    }
    .nav-tab {
      padding: 10px 15px;
      cursor: pointer !important;
      border-radius: 4px;
      margin-right: 5px;
      margin-bottom: 5px;
      color: var(--text-secondary);
      transition: all 0.3s;
      position: relative;
      z-index: 20;
      user-select: none;
      pointer-events: auto !important;
    }
    .nav-tab:hover {
      background-color: rgba(255, 215, 0, 0.1);
      color: var(--primary-color);
    }
    .nav-tab.active {
      background-color: rgba(255, 215, 0, 0.2);
      color: var(--primary-color);
      font-weight: bold;
    }
    
    /* Page Styles */
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    
    /* Report Styles */
    .report-filters {
      background-color: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .report-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .summary-card {
      background-color: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 4px;
      flex: 1;
      min-width: 120px;
      text-align: center;
    }
    .summary-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    .summary-label {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .report-table th, .report-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    .report-table th {
      background-color: rgba(0,0,0,0.2);
      color: var(--primary-color);
    }
    .report-table tr:hover {
      background-color: rgba(255,255,255,0.05);
    }
    .report-table tbody tr:hover {
      background-color: rgba(255, 215, 0, 0.1);
      cursor: pointer;
    }
    .card {
      position: relative;
      z-index: 10;
      background-color: var(--card-color);
    }

    script {
      display: none !important;
    }

    /* Loading Styles */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    /* Force hide loading overlays */
    .loading-overlay.hidden {
      display: none !important;
    }
    
    .spinner {
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 5px solid var(--primary-color);
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    .loading-text {
      color: var(--primary-color);
      font-weight: bold;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .report-container {
      position: relative;
      min-height: 200px;
    }
    
    /* Status Colors */
    .out-of-stock {
      background-color: rgba(244, 67, 54, 0.2) !important;
    }
    .low-stock {
      background-color: rgba(255, 152, 0, 0.2) !important;
    }
    .expired {
      background-color: rgba(244, 67, 54, 0.3) !important;
    }
    .expiring-soon {
      background-color: rgba(255, 152, 0, 0.3) !important;
    }

    /* Turnover Status Colors */
    .very-slow {
      background-color: rgba(255, 0, 0, 0.1) !important;
    }
    .slow {
      background-color: rgba(255, 165, 0, 0.1) !important;
    }
    .optimal {
      background-color: rgba(0, 128, 0, 0.1) !important;
    }
    .fast {
      background-color: rgba(0, 0, 255, 0.1) !important;
    }

    /* Chart container */
    .chart-container {
      background-color: var(--card-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }
    .chart-container h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow: auto;
    }
    .modal-content {
      background-color: var(--card-color);
      margin: 10% auto;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 80%;
      max-width: 500px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .modal-title {
      color: var(--primary-color);
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }
    .close-modal {
      color: var(--text-secondary);
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-modal:hover {
      color: var(--primary-color);
    }
    
    /* Credentials Styles */
    .credential-section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .credential-section h3 {
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 15px;
    }
    .credential-item {
      margin-bottom: 15px;
    }
    .credential-label {
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text-secondary);
    }
    .credential-value {
      padding: 10px;
      background-color: rgba(0,0,0,0.2);
      border-radius: 4px;
      word-break: break-all;
    }
    .credential-value.editable {
      background-color: #3a3a3a;
      border: 1px solid var(--border-color);
    }
    
    /* User Management Styles */
    .user-list {
      margin-top: 20px;
    }
    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .user-name {
      font-weight: bold;
    }
    .user-actions {
      display: flex;
      gap: 10px;
    }
    
    /* Currency Input Styles */
    .currency-input {
      position: relative;
      padding-left: 25px !important;
    }
    
    .currency-display {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }

    /* Expiration Status Colors */
    .expired {
      background-color: rgba(139, 0, 0, 0.2) !important;
      color: #ff6666;
    }
    .expiring-7days {
      background-color: rgba(255, 0, 0, 0.2) !important;
      color: #ff8080;
    }
    .expiring-30days {
      background-color: rgba(255, 165, 0, 0.2) !important;
      color: #ffaa00;
    }
    .expiring-90days {
      background-color: rgba(255, 255, 0, 0.2) !important;
      color: #cccc00;
    }

    /* Checkbox styling */
    .item-checkbox {
      width: 18px !important;
      height: 18px !important;
      margin-right: 10px;
    }

    /* Summary cards for expiration */
    .summary-card.expired {
      background-color: rgba(139, 0, 0, 0.2);
      border-left: 4px solid #8b0000;
    }
    .summary-card.expiring-7days {
      background-color: rgba(255, 0, 0, 0.2);
      border-left: 4px solid #ff0000;
    }
    .summary-card.expiring-30days {
      background-color: rgba(255, 165, 0, 0.2);
      border-left: 4px solid #ffa500;
    }
    .summary-card.expiring-90days {
      background-color: rgba(255, 255, 0, 0.2);
      border-left: 4px solid #ffff00;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="login-screen" class="card">
      <div class="header">
        <div class="logo">
          <img src="https://i.imgur.com/lfcgQ0s.png" alt="VEND LAS VEGAS Logo">
        </div>
        <div class="title-area">
          <h1>VEND LAS VEGAS</h1>
          <div class="machine-id" id="login-machine-id"></div>
        </div>
      </div>
      <h2>Inventory Portal Login</h2>
      <label for="username">Username</label>
      <input type="text" id="username">
      <label for="password">Password</label>
      <input type="password" id="password">
      <div class="btn-group">
        <button onclick="handleLogin()">Login</button>
        <button onclick="showResetMasterPasswordModalFromLogin()" class="btn-secondary">Reset Master Password</button>
      </div>
      <div style="margin-top: 15px; color: var(--text-secondary); font-size: 12px;">
        <p>Username is CaSe sensitive. Contact administrator for login credentials</p>
      </div>
    </div>

    <!-- Main Portal -->
    <div id="main-portal" class="card hidden">
      <div class="header">
        <div class="logo">
          <img src="https://i.imgur.com/lfcgQ0s.png" alt="VEND LAS VEGAS Logo">
        </div>
        <div class="title-area">
          <h1>Inventory Portal</h1>
          <div class="subtitle" id="page-subtitle">Item Entry</div>
          <div class="machine-id" id="portal-machine-id"></div>
        </div>
      </div>

      <!-- Navigation - UPDATED with direct onclick handlers -->
<div class="nav-container">
  <div class="nav-categories">
    <div class="nav-category active" data-category="inventory">Inventory Management</div>
    <div class="nav-category" data-category="financial">Financial Reports</div>
    <div class="nav-category" data-category="customer">Customer Behavior</div>
    <div class="nav-category" data-category="analytics">Advanced Analytics</div>
    <div class="nav-category" data-category="admin">Admin Functions</div>
  </div>
  
  <div class="nav-tabs">
    <!-- Inventory Management -->
    <div class="nav-tab active" data-category="inventory" data-page="item-entry">Item Entry</div>
    <div class="nav-tab" data-category="inventory" data-page="inventory-status">Inventory Status</div>
    <div class="nav-tab" data-category="inventory" data-page="inventory-turnover">Inventory Turnover</div>
    <div class="nav-tab" data-category="inventory" data-page="expiration-tracking">Expiration Tracking</div>
    
    <!-- Financial Reports -->
    <div class="nav-tab hidden" data-category="financial" data-page="sales-report">Sales Report</div>
    <div class="nav-tab hidden" data-category="financial" data-page="product-report">Product Performance</div>
    <div class="nav-tab hidden" data-category="financial" data-page="profit-margin">Profit Margin</div>
    <div class="nav-tab hidden" data-category="financial" data-page="cost-analysis">Cost Analysis</div>
    <div class="nav-tab hidden" data-category="financial" data-page="revenue-forecast">Revenue Forecast</div>
    
    <!-- Customer Behavior -->
    <div class="nav-tab hidden" data-category="customer" data-page="peak-hours">Peak Hours</div>
    <div class="nav-tab hidden" data-category="customer" data-page="product-pairing">Product Pairing</div>
    
    <!-- Advanced Analytics -->
    <div class="nav-tab hidden" data-category="analytics" data-page="seasonal-trends">Seasonal Trends</div>
    <div class="nav-tab hidden" data-category="analytics" data-page="price-sensitivity">Price Sensitivity</div>
    
    <!-- Admin Functions -->
    <div class="nav-tab hidden" data-category="admin" data-page="user-management">User Management</div>
    <div class="nav-tab hidden" data-category="admin" data-page="credentials">Credentials</div>
    <div class="nav-tab hidden" data-category="admin" data-page="discounts">Discounts</div>
  </div>
</div>

          
          <!-- Financial Reports -->
          <div class="nav-tab hidden" data-category="financial" data-page="sales-report" onclick="switchTab('financial', 'sales-report')">Sales Report</div>
          <div class="nav-tab hidden" data-category="financial" data-page="product-report" onclick="switchTab('financial', 'product-report')">Product Performance</div>
          <div class="nav-tab hidden" data-category="financial" data-page="profit-margin" onclick="switchTab('financial', 'profit-margin')">Profit Margin</div>
          <div class="nav-tab hidden" data-category="financial" data-page="cost-analysis" onclick="switchTab('financial', 'cost-analysis')">Cost Analysis</div>
          <div class="nav-tab hidden" data-category="financial" data-page="revenue-forecast" onclick="switchTab('financial', 'revenue-forecast')">Revenue Forecast</div>
          
          <!-- Customer Behavior -->
          <div class="nav-tab hidden" data-category="customer" data-page="peak-hours" onclick="switchTab('customer', 'peak-hours')">Peak Hours</div>
          <div class="nav-tab hidden" data-category="customer" data-page="product-pairing" onclick="switchTab('customer', 'product-pairing')">Product Pairing</div>
          
          <!-- Advanced Analytics -->
          <div class="nav-tab hidden" data-category="analytics" data-page="seasonal-trends" onclick="switchTab('analytics', 'seasonal-trends')">Seasonal Trends</div>
          <div class="nav-tab hidden" data-category="analytics" data-page="price-sensitivity" onclick="switchTab('analytics', 'price-sensitivity')">Price Sensitivity</div>
          
          <!-- Admin Functions -->
          <div class="nav-tab hidden" data-category="admin" data-page="user-management" onclick="switchTab('admin', 'user-management')">User Management</div>
          <div class="nav-tab hidden" data-category="admin" data-page="credentials" onclick="switchTab('admin', 'credentials')">Credentials</div>
          <div class="nav-tab hidden" data-category="admin" data-page="discounts" onclick="switchTab('admin', 'discounts')">Discounts</div>
        </div>
      </div>
            <!-- Item Entry Page -->
      <div id="item-entry-page" class="page active">
        <div class="row">
          <div class="col" style="flex: 2;">
            <label for="upc-input">Enter or Scan UPC</label>
            <input type="text" id="upc-input" placeholder="Scan a product...">
          </div>
          <div class="col" style="align-self: flex-end;">
            <div class="btn-group">
              <button onclick="handleLookup()">Lookup</button>
              <button onclick="handleRequestInfo()" class="btn-secondary">Request Info</button>
            </div>
          </div>
        </div>

        <div id="form-fields">
          <h2>Product Details</h2>
          <div class="row">
            <div class="col"><label for="brand">Brand</label><input type="text" id="brand"></div>
            <div class="col"><label for="name">Name</label><input type="text" id="name"></div>
          </div>
          <div class="row">
            <div class="col"><label for="category">Category</label><input type="text" id="category"></div>
          </div>
          <label for="details">Details / Ingredients</label>
          <textarea id="details" rows="3"></textarea>
          <div class="row">
            <div class="col"><label for="size">Size</label><input type="text" id="size"></div>
            <div class="col"><label for="image">Image URL</label><input type="text" id="image"></div>
          </div>
          <div class="row">
            <div class="col"><label for="calories">Calories</label><input type="text" id="calories"></div>
            <div class="col"><label for="sugar">Sugar</label><input type="text" id="sugar"></div>
            <div class="col"><label for="sodium">Sodium</label><input type="text" id="sodium"></div>
          </div>

          <h2>Pricing & Cost</h2>
          <div class="row">
            <div class="col">
              <label for="price">Retail Price</label>
              <div style="position: relative;">
                <span class="currency-display">$</span>
                <input type="number" id="price" step="0.01" class="currency-input">
              </div>
            </div>
            <div class="col"><label for="taxable">Taxable</label>
              <select id="taxable">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="cost">Purchase Cost (for the unit)</label>
              <div style="position: relative;">
                <span class="currency-display">$</span>
                <input type="number" id="cost" step="0.01" class="currency-input">
              </div>
            </div>
            <div class="col"><label for="purchaseUnitQty">Items in Purchase Unit</label><input type="number" id="purchaseUnitQty"></div>
          </div>
          <div class="row">
            <div class="col">
              <label for="indvCost">Individual Cost</label>
              <div style="position: relative;">
                <span class="currency-display">$</span>
                <input type="number" id="indvCost" readonly class="currency-input">
              </div>
            </div>
            <div class="col">
              <label for="profit">Profit</label>
              <div style="position: relative;">
                <span class="currency-display">$</span>
                <input type="number" id="profit" readonly class="currency-input">
              </div>
            </div>
          </div>
          
          <h2>Stock</h2>
          <div class="row">
            <div class="col"><label for="qty">Current Quantity</label><input type="number" id="qty"></div>
            <div class="col"><label for="expDate">Expiration Date</label><input type="date" id="expDate"></div>
          </div>
          
          <div class="btn-group">
            <button onclick="handleSave()">Save</button>
            <button onclick="handleClear()" class="btn-secondary">Clear</button>
          </div>
        </div>
      </div>
      
      <!-- Inventory Status Page -->
      <div id="inventory-status-page" class="page">
        <h2>Inventory Status</h2>
        
        <div class="report-container">
          <div id="inventory-loading" class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Loading Inventory Status...</div>
          </div>
          
          <div id="inventory-content">
            <div style="overflow-x: auto;">
              <table class="report-table" id="inventory-table">
                <thead>
                  <tr>
                    <th>UPC</th>
                    <th>Brand</th>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody id="inventory-body">
                  <!-- Inventory items will be added here -->
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="5" style="text-align: right; font-weight: bold;">Totals:</td>
                    <td id="total-quantity" style="font-weight: bold;">0</td>
                    <td id="total-value" style="font-weight: bold;">$0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <div class="btn-group" style="margin-top: 30px;">
              <button onclick="exportInventoryToHTMLPDF()">Export to PDF</button>
              <button onclick="loadInventoryStatus()" class="btn-secondary">Refresh</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Inventory Turnover Page -->
      <div id="inventory-turnover-page" class="page">
        <h2>Inventory Turnover</h2>
        
        <div class="report-filters">
          <div class="row">
            <div class="col">
              <label for="turnover-period">Time Period</label>
              <select id="turnover-period">
                <option value="30">Last 30 Days</option>
                <option value="90" selected>Last 90 Days</option>
                <option value="180">Last 180 Days</option>
                <option value="365">Last 365 Days</option>
              </select>
            </div>
            <div class="col">
              <label for="turnover-category">Category</label>
              <select id="turnover-category">
                <option value="all" selected>All Categories</option>
                <!-- Categories will be populated dynamically -->
              </select>
            </div>
            <div class="col" style="align-self: flex-end;">
              <button onclick="loadTurnoverData()">Calculate Turnover</button>
            </div>
          </div>
        </div>
        
        <div class="report-container">
          <div id="turnover-loading" class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Calculating Inventory Turnover...</div>
          </div>
          
          <!-- Summary Cards -->
          <div class="report-summary">
            <div class="summary-card">
              <div class="summary-value" id="overall-turnover">0.0</div>
              <div class="summary-label">Overall Turnover Ratio</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="avg-days-in-inventory">0</div>
              <div class="summary-label">Avg Days in Inventory</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="slow-items-count">0</div>
              <div class="summary-label">Slow-Moving Items</div>
            </div>
            <div class="summary-card">
              <div class="summary-value" id="fast-items-count">0</div>
              <div class="summary-label">Fast-Moving Items</div>
            </div>
          </div>
          
          <!-- Turnover Charts -->
          <div class="row">
            <div class="col">
              <div class="chart-container">
                <h3>Turnover by Category</h3>
                <div id="category-turnover-chart" style="height: 300px;"></div>
              </div>
            </div>
            <div class="col">
              <div class="chart-container">
                <h3>Top 10 Items by Turnover</h3>
                <div id="top-items-chart" style="height: 300px;"></div>
              </div>
            </div>
          </div>
          
          <!-- Turnover Table -->
          <h3>Detailed Turnover Analysis</h3>
          <div style="overflow-x: auto;">
            <table class="report-table" id="turnover-table">
              <thead>
                <tr>
                  <th>UPC</th>
                  <th>Brand</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Beginning</th>
                  <th>Ending</th>
                  <th>Units Sold</th>
                  <th>Turnover</th>
                  <th>Days</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="turnover-body">
                <!-- Turnover data will be added here -->
              </tbody>
            </table>
          </div>
          
          <div class="btn-group" style="margin-top: 30px;">
            <button onclick="exportTurnoverToHTMLPDF()">Export to PDF</button>
            <button onclick="loadTurnoverData()" class="btn-secondary">Refresh Data</button>
          </div>
        </div>
      </div>
      
      <!-- Expiration Tracking Page -->
      <div id="expiration-tracking-page" class="page">
        <h2>Expiration Tracking</h2>
        
        <div class="report-filters">
          <div class="row">
            <div class="col">
              <label for="expiration-filter">Show Items</label>
              <select id="expiration-filter">
                <option value="all">All Items with Expiration Dates</option>
                <option value="expired" selected>Already Expired</option>
                <option value="7days">Expiring in 7 Days</option>
                <option value="30days">Expiring in 30 Days</option>
                <option value="90days">Expiring in 90 Days</option>
              </select>
            </div>
            <div class="col">
              <label for="category-filter">Category</label>
              <select id="category-filter">
                <option value="all" selected>All Categories</option>
                <!-- Categories will be populated dynamically -->
              </select>
            </div>
            <div class="col" style="align-self: flex-end;">
              <button onclick="loadExpirationData()">Refresh Data</button>
            </div>
          </div>
        </div>
        
        <div class="report-container">
          <div id="expiration-loading" class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Loading Expiration Data...</div>
          </div>
          
          <div class="report-summary">
            <div class="summary-card expired">
              <div class="summary-value" id="expired-count">0</div>
              <div class="summary-label">Expired Items</div>
            </div>
            <div class="summary-card expiring-7days">
              <div class="summary-value" id="expiring-7-count">0</div>
              <div class="summary-label">Expiring in 7 Days</div>
            </div>
            <div class="summary-card expiring-30days">
              <div class="summary-value" id="expiring-30-count">0</div>
              <div class="summary-label">Expiring in 30 Days</div>
            </div>
            <div class="summary-card expiring-90days">
              <div class="summary-value" id="expiring-90-count">0</div>
              <div class="summary-label">Expiring in 90 Days</div>
            </div>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="report-table" id="expiration-table">
              <thead>
                <tr>
                  <th>UPC</th>
                  <th>Brand</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Quantity</th>
                  <th>Expiration Date</th>
                  <th>Days Left</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="expiration-body">
                <!-- Expiration data will be added here -->
              </tbody>
            </table>
          </div>
          
          <div class="btn-group" style="margin-top: 30px;">
            <button onclick="exportExpirationToHTMLPDF()">Export to PDF</button>
            <button onclick="showMarkLossModal()" class="btn-danger">Mark as Loss</button>
          </div>
        </div>
      </div>
      
      <!-- Sales Report Page -->
      <div id="sales-report-page" class="page">
        <h2>Sales Report</h2>
        
        <div class="report-filters">
          <div class="row">
            <div class="col">
              <label for="start-date">Start Date</label>
              <input type="date" id="start-date">
            </div>
            <div class="col">
              <label for="end-date">End Date</label>
              <input type="date" id="end-date">
            </div>
            <div class="col" style="align-self: flex-end;">
              <button onclick="generateSalesReport()">Generate Report</button>
            </div>
          </div>
        </div>
        
        <div class="report-container">
          <div id="sales-loading" class="loading-overlay hidden">
            <div class="spinner"></div>
            <div class="loading-text">Generating Sales Report...</div>
          </div>
          
          <div id="report-content" class="hidden">
            <div class="report-summary">
              <div class="summary-card">
                <div class="summary-value" id="total-transactions">0</div>
                <div class="summary-label">Transactions</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="total-items">0</div>
                <div class="summary-label">Items Sold</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="total-subtotal">$0.00</div>
                <div class="summary-label">Subtotal</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="total-tax">$0.00</div>
                <div class="summary-label">Tax</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="total-revenue">$0.00</div>
                <div class="summary-label">Total</div>
              </div>
            </div>
            
            <h3>Transaction Details</h3>
            <div style="overflow-x: auto;">
              <table class="report-table" id="transactions-table">
                <thead>
                  <tr>
                    <th>Transaction ID</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Items</th>
                    <th>Payment Method</th>
                    <th>Subtotal</th>
                    <th>Tax</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="transactions-body">
                  <!-- Transactions will be added here -->
                </tbody>
              </table>
            </div>
            
            <div class="btn-group" style="margin-top: 30px;">
              <button onclick="exportToHTMLPDF()">Export to PDF</button>
              <button onclick="clearReport()" class="btn-secondary">Clear Report</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Product Performance Report Page -->
      <div id="product-report-page" class="page">
        <h2>Product Performance Report</h2>
        
        <div class="report-filters">
          <div class="row">
            <div class="col">
              <label for="product-start-date">Start Date</label>
              <input type="date" id="product-start-date">
            </div>
            <div class="col">
              <label for="product-end-date">End Date</label>
              <input type="date" id="product-end-date">
            </div>
            <div class="col" style="align-self: flex-end;">
              <button onclick="generateProductReport()">Generate Report</button>
            </div>
          </div>
        </div>
        
        <div class="report-container">
          <div id="product-loading" class="loading-overlay hidden">
            <div class="spinner"></div>
            <div class="loading-text">Generating Product Report...</div>
          </div>
          
          <div id="product-report-content" class="hidden">
            <div class="report-summary">
              <div class="summary-card">
                <div class="summary-value" id="total-products">0</div>
                <div class="summary-label">Products Sold</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="total-quantity">0</div>
                <div class="summary-label">Total Quantity</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="avg-price">$0.00</div>
                <div class="summary-label">Average Price</div>
              </div>
              <div class="summary-card">
                <div class="summary-value" id="total-profit">$0.00</div>
                <div class="summary-label">Total Profit</div>
              </div>
            </div>
            
            <h3>Top Selling Products</h3>
            <div style="overflow-x: auto;">
              <table class="report-table" id="products-table">
                <thead>
                  <tr>
                    <th>UPC</th>
                    <th>Product Name</th>
                    <th>Brand</th>
                    <th>Quantity Sold</th>
                    <th>Unit Price</th>
                    <th>Total Sales</th>
                    <th>Profit</th>
                  </tr>
                </thead>
                <tbody id="products-body">
                  <!-- Products will be added here -->
                </tbody>
              </table>
            </div>
            
            <div id="product-chart" style="width: 100%; height: 300px; margin-top: 30px;"></div>
            
            <div class="btn-group" style="margin-top: 30px;">
              <button onclick="exportProductReportToHTMLPDF()">Export to PDF</button>
              <button onclick="clearProductReport()" class="btn-secondary">Clear Report</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Profit Margin Page -->
<div id="profit-margin-page" class="page">
  <h2>Profit Margin Analysis</h2>
  
  <div class="report-filters">
    <div class="row">
      <div class="col">
        <label for="profit-start-date">Start Date</label>
        <input type="date" id="profit-start-date">
      </div>
      <div class="col">
        <label for="profit-end-date">End Date</label>
        <input type="date" id="profit-end-date">
      </div>
      <div class="col">
        <label for="profit-category-filter">Category</label>
        <select id="profit-category-filter">
          <option value="all" selected>All Categories</option>
          <!-- Categories will be populated dynamically -->
        </select>
      </div>
      <div class="col" style="align-self: flex-end;">
        <button onclick="generateProfitMarginReport()">Generate Report</button>
      </div>
    </div>
  </div>
  
  <div class="report-container">
    <div id="profit-loading" class="loading-overlay hidden">
      <div class="spinner"></div>
      <div class="loading-text">Generating Profit Margin Report...</div>
    </div>
    
    <div id="profit-report-content" class="hidden">
      <div class="report-summary">
        <div class="summary-card">
          <div class="summary-value" id="avg-margin-percent">0%</div>
          <div class="summary-label">Average Margin %</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="total-revenue">$0.00</div>
          <div class="summary-label">Total Revenue</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="total-cost">$0.00</div>
          <div class="summary-label">Total Cost</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="total-profit">$0.00</div>
          <div class="summary-label">Total Profit</div>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <div class="chart-container">
            <h3>Profit Margin by Category</h3>
            <div id="category-margin-chart" style="height: 300px;"></div>
          </div>
        </div>
        <div class="col">
          <div class="chart-container">
            <h3>Top 10 Products by Margin</h3>
            <div id="top-margin-chart" style="height: 300px;"></div>
          </div>
        </div>
      </div>
      
      <h3>Detailed Margin Analysis</h3>
      <div style="overflow-x: auto;">
        <table class="report-table" id="margin-table">
          <thead>
            <tr>
              <th>UPC</th>
              <th>Product</th>
              <th>Category</th>
              <th>Quantity Sold</th>
              <th>Unit Price</th>
              <th>Unit Cost</th>
              <th>Revenue</th>
              <th>Cost</th>
              <th>Profit</th>
              <th>Margin %</th>
            </tr>
          </thead>
          <tbody id="margin-body">
            <!-- Margin data will be added here -->
          </tbody>
        </table>
      </div>
      
      <div class="btn-group" style="margin-top: 30px;">
        <button onclick="exportProfitMarginReportToHTMLPDF()">Export to PDF</button>
        <button onclick="clearProfitMarginReport()" class="btn-secondary">Clear Report</button>
      </div>
    </div>
  </div>
</div>

<!-- Cost Analysis Page -->
<div id="cost-analysis-page" class="page">
  <h2>Cost Analysis</h2>
  
  <div class="report-filters">
    <div class="row">
      <div class="col">
        <label for="cost-start-date">Start Date</label>
        <input type="date" id="cost-start-date">
      </div>
      <div class="col">
        <label for="cost-end-date">End Date</label>
        <input type="date" id="cost-end-date">
      </div>
      <div class="col">
        <label for="cost-category-filter">Category</label>
        <select id="cost-category-filter">
          <option value="all" selected>All Categories</option>
          <!-- Categories will be populated dynamically -->
        </select>
      </div>
      <div class="col" style="align-self: flex-end;">
        <button onclick="generateCostAnalysisReport()">Generate Report</button>
      </div>
    </div>
  </div>
  
  <div class="report-container">
    <div id="cost-loading" class="loading-overlay hidden">
      <div class="spinner"></div>
      <div class="loading-text">Generating Cost Analysis Report...</div>
    </div>
    
    <div id="cost-report-content" class="hidden">
      <div class="report-summary">
        <div class="summary-card">
          <div class="summary-value" id="total-inventory-cost">$0.00</div>
          <div class="summary-label">Total Inventory Cost</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="avg-item-cost">$0.00</div>
          <div class="summary-label">Average Item Cost</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="highest-cost-item">N/A</div>
          <div class="summary-label">Highest Cost Item</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="lowest-cost-item">N/A</div>
          <div class="summary-label">Lowest Cost Item</div>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <div class="chart-container">
            <h3>Cost Distribution by Category</h3>
            <div id="category-cost-chart" style="height: 300px;"></div>
          </div>
        </div>
        <div class="col">
          <div class="chart-container">
            <h3>Top 10 Highest Cost Items</h3>
            <div id="top-cost-chart" style="height: 300px;"></div>
          </div>
        </div>
      </div>
      
      <h3>Cost Breakdown by Category</h3>
      <div style="overflow-x: auto;">
        <table class="report-table" id="category-cost-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Items</th>
              <th>Total Cost</th>
              <th>Avg Cost per Item</th>
              <th>% of Total Cost</th>
            </tr>
          </thead>
          <tbody id="category-cost-body">
            <!-- Category cost data will be added here -->
          </tbody>
        </table>
      </div>
      
      <h3>Detailed Cost Analysis</h3>
      <div style="overflow-x: auto;">
        <table class="report-table" id="cost-table">
          <thead>
            <tr>
              <th>UPC</th>
              <th>Product</th>
              <th>Category</th>
              <th>Quantity</th>
              <th>Unit Cost</th>
              <th>Total Cost</th>
              <th>Last Sold</th>
              <th>Days in Inventory</th>
            </tr>
          </thead>
          <tbody id="cost-body">
            <!-- Cost data will be added here -->
          </tbody>
        </table>
      </div>
      
      <div class="btn-group" style="margin-top: 30px;">
        <button onclick="exportCostAnalysisReportToHTMLPDF()">Export to PDF</button>
        <button onclick="clearCostAnalysisReport()" class="btn-secondary">Clear Report</button>
      </div>
    </div>
  </div>
</div>
      
<!-- Revenue Forecast Page -->
<div id="revenue-forecast-page" class="page">
  <h2>Revenue Forecast</h2>
  
  <div class="report-filters">
    <div class="row">
      <div class="col">
        <label for="forecast-start-date">Historical Start Date</label>
        <input type="date" id="forecast-start-date">
      </div>
      <div class="col">
        <label for="forecast-end-date">Historical End Date</label>
        <input type="date" id="forecast-end-date">
      </div>
      <div class="col">
        <label for="forecast-period">Forecast Period</label>
        <select id="forecast-period">
          <option value="30">Next 30 Days</option>
          <option value="60">Next 60 Days</option>
          <option value="90" selected>Next 90 Days</option>
          <option value="180">Next 180 Days</option>
        </select>
      </div>
      <div class="col" style="align-self: flex-end;">
        <button onclick="generateRevenueForecast()">Generate Forecast</button>
      </div>
    </div>
  </div>
  
  <div class="report-container">
    <div id="forecast-loading" class="loading-overlay hidden">
      <div class="spinner"></div>
      <div class="loading-text">Generating Revenue Forecast...</div>
    </div>
    
    <div id="forecast-report-content" class="hidden">
      <div class="report-summary">
        <div class="summary-card">
          <div class="summary-value" id="forecast-total-revenue">$0.00</div>
          <div class="summary-label">Forecasted Revenue</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="forecast-daily-avg">$0.00</div>
          <div class="summary-label">Daily Average</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="forecast-growth">0%</div>
          <div class="summary-label">Growth Rate</div>
        </div>
        <div class="summary-card">
          <div class="summary-value" id="forecast-confidence">0%</div>
          <div class="summary-label">Confidence Level</div>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <div class="chart-container">
            <h3>Revenue Trend & Forecast</h3>
            <div id="revenue-trend-chart" style="height: 300px;"></div>
          </div>
        </div>
        <div class="col">
          <div class="chart-container">
            <h3>Monthly Revenue Forecast</h3>
            <div id="monthly-forecast-chart" style="height: 300px;"></div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col">
          <div class="chart-container">
            <h3>Top 5 Product Categories</h3>
            <div id="category-forecast-chart" style="height: 300px;"></div>
          </div>
        </div>
        <div class="col">
          <div class="chart-container">
            <h3>Weekly Revenue Pattern</h3>
            <div id="weekly-pattern-chart" style="height: 300px;"></div>
          </div>
        </div>
      </div>
      
      <h3>Monthly Revenue Forecast</h3>
      <div style="overflow-x: auto;">
        <table class="report-table" id="monthly-forecast-table">
          <thead>
            <tr>
              <th>Month</th>
              <th>Forecasted Revenue</th>
              <th>Lower Bound</th>
              <th>Upper Bound</th>
              <th>Historical Average</th>
              <th>Growth %</th>
            </tr>
          </thead>
          <tbody id="monthly-forecast-body">
            <!-- Monthly forecast data will be added here -->
          </tbody>
        </table>
      </div>
      
      <h3>Top Products Forecast</h3>
      <div style="overflow-x: auto;">
        <table class="report-table" id="product-forecast-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Historical Units/Month</th>
              <th>Forecasted Units</th>
              <th>Unit Price</th>
              <th>Forecasted Revenue</th>
              <th>Trend</th>
            </tr>
          </thead>
          <tbody id="product-forecast-body">
            <!-- Product forecast data will be added here -->
          </tbody>
        </table>
      </div>
      
      <div class="btn-group" style="margin-top: 30px;">
        <button onclick="exportRevenueForecastToHTMLPDF()">Export to PDF</button>
        <button onclick="clearRevenueForecast()" class="btn-secondary">Clear Forecast</button>
      </div>
    </div>
  </div>
</div>


      <!-- User Management Page -->
      <div id="user-management-page" class="page">
        <h2>User Management</h2>
        
        <div class="btn-group" style="margin-bottom: 30px;">
          <button onclick="showAddUserModal()">Add User</button>
          <button onclick="showResetMasterPasswordModal()" class="btn-secondary">Reset Master Password</button>
        </div>
        
        <div id="user-list" class="user-list">
          <!-- Users will be added here dynamically -->
          <div class="loading-text">Loading users...</div>
        </div>
      </div>
      
      <!-- Credentials Page -->
      <div id="credentials-page" class="page">
        <h2>System Credentials</h2>
        
        <div id="credentials-auth-form">
          <label for="credentials-master-password">Enter Master Password</label>
          <input type="password" id="credentials-master-password">
          <button onclick="authenticateCredentials()">Access Credentials</button>
        </div>
        
        <div id="credentials-container" class="hidden">
          <!-- Credentials will be loaded here -->
          <div class="loading-text">Loading credentials...</div>
        </div>
        
        <div class="btn-group" style="margin-top: 30px;">
          <button onclick="saveCredentials()" id="save-credentials-btn" class="hidden">Save Changes</button>
          <button onclick="loadCredentialsWithAuth()" class="btn-secondary hidden" id="refresh-credentials-btn">Refresh</button>
        </div>
      </div>

      <!-- Discounts Page -->
      <div id="discounts-page" class="page">
        <div class="card">
          <h2>Discount Management</h2>

          <button onclick="forceHideDiscountsLoading()" style="position: absolute; top: 10px; right: 10px; z-index: 9999;">
            Hide Loading
          </button>
          
          <div class="row">
            <div class="col">
              <label for="discount-code">Discount Code</label>
              <input type="text" id="discount-code" placeholder="Enter discount code">
            </div>
            <div class="col">
              <label for="discount-type">Discount Type</label>
              <select id="discount-type">
                <option value="Coupon">Coupon</option>
                <option value="Promo Code">Promo Code</option>
                <option value="Customer">Customer</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="col">
              <label for="discount-once">One-time Use</label>
              <input type="checkbox" id="discount-once">
            </div>
            <div class="col">
              <label for="discount-expiration">Expiration Date</label>
              <input type="date" id="discount-expiration">
            </div>
          </div>
          
          <div class="row">
            <div class="col">
              <label for="discount-dollar">Dollar Amount ($)</label>
              <div style="position: relative;">
                <span class="currency-display">$</span>
                <input type="number" id="discount-dollar" step="0.01" class="currency-input">
              </div>
            </div>
            <div class="col">
              <label for="discount-percent">Percentage (%)</label>
              <input type="number" id="discount-percent" min="0" max="100">
            </div>
            <div class="col">
              <label for="discount-total">Apply to Total</label>
              <input type="checkbox" id="discount-total">
            </div>
          </div>
          
          <div class="row">
            <div class="col">
              <label for="discount-category">Category Restriction</label>
              <select id="discount-category">
                <option value="">No Restriction</option>
                <!-- Categories will be populated dynamically -->
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="col">
              <label>Item Restrictions</label>
              <div class="row">
                <div class="col">
                  <input type="text" id="discount-item1" placeholder="Item 1">
                </div>
                <div class="col">
                  <input type="text" id="discount-item2" placeholder="Item 2">
                </div>
              </div>
              <div class="row" style="margin-top: 10px;">
                <div class="col">
                  <input type="text" id="discount-item3" placeholder="Item 3">
                </div>
                <div class="col">
                  <input type="text" id="discount-item4" placeholder="Item 4">
                </div>
                <div class="col">
                  <input type="text" id="discount-item5" placeholder="Item 5">
                </div>
              </div>
            </div>
          </div>
          
          <div class="btn-group" style="margin-top: 20px;">
            <button onclick="saveDiscount()" class="btn-primary">Save Discount</button>
            <button onclick="clearDiscountForm()" class="btn-secondary">Clear Form</button>
          </div>
          
          <h3 style="margin-top: 30px;">Existing Discounts</h3>
          <div id="discounts-loading" class="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Loading discounts...</div>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="report-table" id="discounts-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Type</th>
                  <th>One-time</th>
                  <th>Expiration</th>
                  <th>Amount</th>
                  <th>Percent</th>
                  <th>Total</th>
                  <th>Category</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="discounts-body">
                <!-- Discounts will be added here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modals -->
    <div id="add-user-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Add New User</h3>
          <span class="close-modal" onclick="closeModal('add-user-modal')">×</span>
        </div>
        <div class="modal-body">
          <label for="master-password-add">Master Password</label>
          <input type="password" id="master-password-add">
          
          <label for="new-username">Username</label>
          <input type="text" id="new-username">
          
          <label for="new-password">Password</label>
          <input type="password" id="new-password">
          
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password">
          
          <div class="btn-group" style="margin-top: 20px;">
            <button onclick="addUser()">Add User</button>
            <button onclick="closeModal('add-user-modal')" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="delete-user-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Delete User</h3>
          <span class="close-modal" onclick="closeModal('delete-user-modal')">×</span>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete user <span id="delete-username" style="font-weight: bold;"></span>?</p>
          
          <label for="master-password-delete">Master Password</label>
          <input type="password" id="master-password-delete">
          
          <input type="hidden" id="username-to-delete">
          
          <div class="btn-group" style="margin-top: 20px;">
            <button onclick="deleteUser()" class="btn-danger">Delete User</button>
            <button onclick="closeModal('delete-user-modal')" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="reset-password-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Reset Master Password</h3>
          <span class="close-modal" onclick="closeModal('reset-password-modal')">×</span>
        </div>
        <div class="modal-body">
          <label for="current-master-password">Current Master Password</label>
          <input type="password" id="current-master-password">
          
          <label for="new-master-password">New Master Password</label>
          <input type="password" id="new-master-password">
          
          <label for="confirm-master-password">Confirm New Password</label>
          <input type="password" id="confirm-master-password">
          
          <div class="btn-group" style="margin-top: 20px;">
            <button onclick="resetMasterPassword()">Reset Password</button>
            <button onclick="closeModal('reset-password-modal')" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mark Loss Modal -->
    <div id="mark-loss-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Record Inventory Loss</h3>
          <span class="close-modal" onclick="closeModal('mark-loss-modal')">×</span>
        </div>
        <div class="modal-body">
          <p>Record loss for selected items:</p>
          <div id="loss-items-list">
            <!-- Selected items will be listed here -->
          </div>
          
          <label for="loss-reason">Reason for Loss</label>
          <select id="loss-reason">
            <option value="Expired">Expired</option>
            <option value="Damaged">Damaged</option>
            <option value="Theft">Theft</option>
            <option value="Other">Other</option>
          </select>
          
          <label for="loss-notes">Notes</label>
          <textarea id="loss-notes" rows="3"></textarea>
          
          <div class="btn-group" style="margin-top: 20px;">
            <button onclick="recordLoss()" class="btn-danger">Record Loss</button>
            <button onclick="closeModal('mark-loss-modal')" class="btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <div id="status"></div>
  </div>



  <script>
    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('JavaScript error:', message, 'at', source, 'line', lineno, ':', error);
      return true;
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', function() {
      // Load Google Charts
      google.charts.load('current', {'packages':['corechart', 'bar']});
      
      /* Comment out existing navigation event listeners
      // Set up category navigation
      document.querySelectorAll('.nav-category').forEach(category => {
        category.addEventListener('click', function() {
          // ...
        });
      });
      
      // Set up tab navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // ...
        });
      });
      */
      
      // Set today's date as default for report date fields
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('end-date').value = today;
      document.getElementById('product-end-date').value = today;
      
      // Set default start date to 30 days ago
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('start-date').value = thirtyDaysAgoStr;
      document.getElementById('product-start-date').value = thirtyDaysAgoStr;
      
      // Load machine ID
      loadMachineID();
      
      // Set up auto-calculation for cost fields
      document.getElementById('price').addEventListener('input', calculateDerivedValues);
      document.getElementById('cost').addEventListener('input', calculateDerivedValues);
      document.getElementById('purchaseUnitQty').addEventListener('input', calculateDerivedValues);
      
      // Load Google Charts
      google.charts.load('current', {'packages':['corechart', 'bar', 'calendar']});
      
      // Verify page IDs
      verifyPageIds();
    });
    // Direct navigation functions
    function switchCategory(categoryName) {
      console.log('Switching to category:', categoryName);
      
      // Update active category
      document.querySelectorAll('.nav-category').forEach(c => c.classList.remove('active'));
      document.querySelector(`.nav-category[data-category="${categoryName}"]`).classList.add('active');
      
      // Hide all tabs
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.add('hidden');
      });
      
      // Show tabs for this category
      document.querySelectorAll(`.nav-tab[data-category="${categoryName}"]`).forEach(tab => {
        tab.classList.remove('hidden');
      });
      
      // Select first tab in this category
      const firstTab = document.querySelector(`.nav-tab[data-category="${categoryName}"]`);
      if (firstTab) {
        const page = firstTab.getAttribute('data-page');
        switchTab(categoryName, page);
      }
    }

    function switchTab(categoryName, pageName) {
      console.log('Switching to tab:', categoryName, pageName);
      
      // Update active tab
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.nav-tab[data-category="${categoryName}"][data-page="${pageName}"]`).classList.add('active');
      
      // Update page subtitle
      const tabElement = document.querySelector(`.nav-tab[data-category="${categoryName}"][data-page="${pageName}"]`);
      document.getElementById('page-subtitle').textContent = tabElement.textContent;
      
      // Show corresponding page
      const pageId = pageName + '-page';
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      
      const page = document.getElementById(pageId);
      if (page) {
        page.classList.add('active');
        
        // Special handling for specific pages
        if (pageName === 'inventory-status') {
          loadInventoryStatus();
        } else if (pageName === 'expiration-tracking') {
          loadExpirationData();
        } else if (pageName === 'inventory-turnover') {
          loadTurnoverData();
        } else if (pageName === 'user-management') {
          loadUsers();
        } else if (pageName === 'credentials') {
          loadCredentials();
        } else if (pageName === 'discounts') {
          loadDiscounts();
        }
      } else {
        console.error('Page not found:', pageId);
      }
    }
    
    // Debug navigation function
    function debugNavigation() {
      console.log('--- Navigation Debug Info ---');
      
      // Check categories
      const categories = document.querySelectorAll('.nav-category');
      console.log(`Found ${categories.length} categories:`);
      categories.forEach(cat => {
        console.log(`- ${cat.textContent} (${cat.getAttribute('data-category')}) ${cat.classList.contains('active') ? '[ACTIVE]' : ''}`);
      });
      
      // Check tabs
      const tabs = document.querySelectorAll('.nav-tab');
      console.log(`Found ${tabs.length} tabs:`);
      tabs.forEach(tab => {
        const isHidden = tab.classList.contains('hidden');
        const isActive = tab.classList.contains('active');
        console.log(`- ${tab.textContent} (${tab.getAttribute('data-category')}/${tab.getAttribute('data-page')}) ${isActive ? '[ACTIVE]' : ''} ${isHidden ? '[HIDDEN]' : ''}`);
      });
      
      // Check pages
      const pages = document.querySelectorAll('.page');
      console.log(`Found ${pages.length} pages:`);
      pages.forEach(page => {
        const id = page.id;
        const isActive = page.classList.contains('active');
        console.log(`- ${id} ${isActive ? '[ACTIVE]' : ''}`);
      });
      
      // Test click on a category
      console.log('Testing click on Financial Reports category...');
      try {
        document.querySelector('.nav-category[data-category="financial"]').click();
        console.log('Click successful');
      } catch (e) {
        console.error('Click failed:', e);
      }
    }
    
    // Function to verify page IDs
    function verifyPageIds() {
      const tabs = document.querySelectorAll('.nav-tab');
      let hasErrors = false;
      
      tabs.forEach(tab => {
        const pageId = tab.getAttribute('data-page') + '-page';
        const page = document.getElementById(pageId);
        
        if (!page) {
          console.error(`Missing page element with ID "${pageId}" for tab "${tab.textContent}"`);
          hasErrors = true;
        }
      });
      
      if (!hasErrors) {
        console.log('All page IDs verified successfully!');
      }
      
      return !hasErrors;
    }
    
    // Function to force hide all loading overlays
    function forceHideLoadingOverlays() {
      // Get all loading overlays
      const overlays = document.querySelectorAll('.loading-overlay');
      
      // Force hide each one
      overlays.forEach(overlay => {
        overlay.style.display = 'none';
        overlay.classList.add('hidden');
      });
    }
    
    // Function to hide all loading overlays
    function hideAllLoadingOverlays() {
      document.querySelectorAll('.loading-overlay').forEach(overlay => {
        overlay.classList.add('hidden');
      });
    }
    
    function forceHideDiscountsLoading() {
      const loadingOverlay = document.getElementById('discounts-loading');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
        loadingOverlay.classList.add('hidden');
      }
    }
    
    function loadMachineID() {
      google.script.run
        .withSuccessHandler(function(machineID) {
          document.getElementById('login-machine-id').textContent = 'Machine ID: ' + machineID;
          document.getElementById('portal-machine-id').textContent = 'Machine ID: ' + machineID;
        })
        .withFailureHandler(function(error) {
          console.error('Error loading machine ID:', error);
        })
        .getMachineID();
    }

    // --- INVENTORY TURNOVER LOGIC ---
    function loadTurnoverData() {
      // Show loading indicator
      document.getElementById('turnover-loading').classList.remove('hidden');
      showStatus('Calculating inventory turnover...', 'info');
      
      // Get filter values
      const period = document.getElementById('turnover-period').value;
      const category = document.getElementById('turnover-category').value;
      
      // Add a safety timeout to hide the loading overlay after 15 seconds
      setTimeout(function() {
        document.getElementById('turnover-loading').classList.add('hidden');
      }, 15000);
      
      google.script.run
        .withSuccessHandler(function(turnoverData) {
          // Hide loading indicator
          document.getElementById('turnover-loading').classList.add('hidden');
          
          console.log('Turnover data received:', turnoverData);
          
          if (!turnoverData) {
            return showStatus('No data received from server. Please try again.', 'error');
          }
          
          displayTurnoverData(turnoverData, period, category);
          
          // Log this action
          logUserAction('Viewed inventory turnover');
        })
        .withFailureHandler(function(error) {
          // Hide loading indicator
          document.getElementById('turnover-loading').classList.add('hidden');
          console.error('Error calculating turnover:', error);
          showStatus('Error calculating turnover: ' + (error.message || error), 'error');
        })
        .getInventoryTurnoverData(period, category);
    }

    function displayTurnoverData(turnoverData, period, category) {
      hideStatus();
      
      if (!turnoverData) {
        return showStatus('No turnover data received from server.', 'error');
      }
      
      if (!turnoverData.success) {
        return showStatus(turnoverData.message || 'Unknown error calculating turnover.', 'error');
      }
      
      // Update summary metrics
      document.getElementById('overall-turnover').textContent = turnoverData.overallTurnover.toFixed(2);
      document.getElementById('avg-days-in-inventory').textContent = Math.round(turnoverData.avgDaysInInventory);
      document.getElementById('slow-items-count').textContent = turnoverData.slowItemsCount;
      document.getElementById('fast-items-count').textContent = turnoverData.fastItemsCount;
      
      // Draw charts
      drawCategoryTurnoverChart(turnoverData.categoryTurnover);
      drawTopItemsChart(turnoverData.topItems);
      
      // Populate turnover table
      const tableBody = document.getElementById('turnover-body');
      tableBody.innerHTML = '';
      
      if (turnoverData.items && turnoverData.items.length > 0) {
        turnoverData.items.forEach(item => {
          const row = document.createElement('tr');
          
          // Add appropriate class based on turnover status
          if (item.turnoverRatio < 1) {
            row.classList.add('very-slow');
          } else if (item.turnoverRatio < 2) {
            row.classList.add('slow');
          } else if (item.turnoverRatio > 6) {
            row.classList.add('fast');
          } else {
            row.classList.add('optimal');
          }
          
          // Format the status text
          let statusText = '';
          if (item.turnoverRatio < 1) {
            statusText = 'VERY SLOW';
          } else if (item.turnoverRatio < 2) {
            statusText = 'SLOW';
          } else if (item.turnoverRatio > 6) {
            statusText = 'FAST';
          } else {
            statusText = 'OPTIMAL';
          }
          
          row.innerHTML = `
            <td>${item.upc || 'N/A'}</td>
            <td>${item.brand || 'N/A'}</td>
            <td>${item.name || 'N/A'}</td>
            <td>${item.category || 'N/A'}</td>
            <td>${item.beginningInventory}</td>
            <td>${item.endingInventory}</td>
            <td>${item.unitsSold}</td>
            <td>${item.turnoverRatio.toFixed(2)}</td>
            <td>${Math.round(item.daysInInventory)}</td>
            <td>${statusText}</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        showStatus('Turnover data loaded successfully!', 'success');
      } else {
        tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No turnover data available for the selected period.</td></tr>';
        showStatus('No turnover data available for the selected period.', 'info');
      }
      
      // Populate category filter if needed
      if (turnoverData.categories && turnoverData.categories.length > 0) {
        const categorySelect = document.getElementById('turnover-category');
        
        // Save current selection
        const currentSelection = categorySelect.value;
        
        // Clear existing options except the first one
        while (categorySelect.options.length > 1) {
          categorySelect.remove(1);
        }
        
        // Add new options
        turnoverData.categories.forEach(category => {
          if (category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
          }
        });
        
        // Restore selection if possible
        if (currentSelection && Array.from(categorySelect.options).some(opt => opt.value === currentSelection)) {
          categorySelect.value = currentSelection;
        }
      }
    }

    function drawCategoryTurnoverChart(categoryData) {
      if (!categoryData || categoryData.length === 0) return;
      
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Category');
      data.addColumn('number', 'Turnover Ratio');
      
      categoryData.forEach(item => {
        data.addRow([item.category, item.turnoverRatio]);
      });
      
      const options = {
        title: 'Inventory Turnover by Category',
        colors: ['#FFD700'],
        backgroundColor: { fill:'transparent' },
        titleTextStyle: { color: '#FFD700' },
        legend: { textStyle: { color: '#ffffff' } },
        hAxis: { textStyle: { color: '#ffffff' } },
        vAxis: { textStyle: { color: '#ffffff' }, title: 'Turnover Ratio', titleTextStyle: { color: '#ffffff' } }
      };
      
      const chart = new google.visualization.ColumnChart(document.getElementById('category-turnover-chart'));
      chart.draw(data, options);
    }

    function drawTopItemsChart(topItems) {
      if (!topItems || topItems.length === 0) return;
      
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Product');
      data.addColumn('number', 'Turnover Ratio');
      
      topItems.forEach(item => {
        data.addRow([item.name, item.turnoverRatio]);
      });
      
      const options = {
        title: 'Top 10 Items by Turnover',
        colors: ['#FFD700'],
        backgroundColor: { fill:'transparent' },
        titleTextStyle: { color: '#FFD700' },
        legend: { textStyle: { color: '#ffffff' } },
        hAxis: { textStyle: { color: '#ffffff' } },
        vAxis: { textStyle: { color: '#ffffff' }, title: 'Turnover Ratio', titleTextStyle: { color: '#ffffff' } }
      };
      
      const chart = new google.visualization.BarChart(document.getElementById('top-items-chart'));
      chart.draw(data, options);
    }
   
    // --- INVENTORY STATUS LOGIC ---
    function loadInventoryStatus() {
      // Show loading indicator
      document.getElementById('inventory-loading').classList.remove('hidden');
      showStatus('Loading inventory status...', 'info');
      
      google.script.run
        .withSuccessHandler(function(inventoryData) {
          // Hide loading indicator
          document.getElementById('inventory-loading').classList.add('hidden');
          
          console.log('Inventory data received:', inventoryData);
          
          if (!inventoryData) {
            return showStatus('No data received from server. Please try again.', 'error');
          }
          
          displayInventoryStatus(inventoryData);
          
          // Log this action
          logUserAction('Viewed inventory status');
        })
        .withFailureHandler(function(error) {
          // Hide loading indicator
          document.getElementById('inventory-loading').classList.add('hidden');
          console.error('Error loading inventory status:', error);
          showStatus('Error loading inventory status: ' + (error.message || error), 'error');
        })
        .getInventoryStatus();
    }

    function exportTurnoverToHTMLPDF() {
      showStatus("Generating PDF...", 'info');
      
      // Get filter values
      const period = document.getElementById('turnover-period').value;
      const category = document.getElementById('turnover-category').value;
      
      google.script.run
        .withSuccessHandler(function(pdfUrl) {
          if (pdfUrl) {
            window.open(pdfUrl, '_blank');
            showStatus('PDF generated successfully!', 'success');
            
            // Log this action
            logUserAction('Exported turnover report to PDF');
          } else {
            showStatus('Failed to generate PDF.', 'error');
          }
        })
        .withFailureHandler(onFailure)
        .exportTurnoverReportToHTMLPDF(period, category);
    }

    function displayInventoryStatus(inventoryData) {
      hideStatus();
      
      if (!inventoryData) {
        return showStatus('No inventory data received from server.', 'error');
      }
      
      if (!inventoryData.success) {
        return showStatus(inventoryData.message || 'Unknown error loading inventory.', 'error');
      }
      
      // Populate inventory table
      const tableBody = document.getElementById('inventory-body');
      tableBody.innerHTML = '';
      
      if (inventoryData.items && inventoryData.items.length > 0) {
        inventoryData.items.forEach(item => {
          const row = document.createElement('tr');
          row.style.cursor = 'pointer';
          row.onclick = function() { loadItemInEntryScreen(item.upc); };
          
          row.innerHTML = `
            <td>${item.upc || 'N/A'}</td>
            <td>${item.brand || 'N/A'}</td>
            <td>${item.name || 'N/A'}</td>
            <td>${item.size || 'N/A'}</td>
            <td>$${(item.price || 0).toFixed(2)}</td>
            <td>${item.qty || '0'}</td>
            <td>$${(item.value || 0).toFixed(2)}</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // Update totals
        document.getElementById('total-quantity').textContent = inventoryData.totalQuantity;
        document.getElementById('total-value').textContent = '$' + inventoryData.totalValue.toFixed(2);
        
        showStatus('Inventory status loaded successfully!', 'success');
      } else {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No inventory items found with positive quantity.</td></tr>';
        document.getElementById('total-quantity').textContent = '0';
        document.getElementById('total-value').textContent = '$0.00';
        showStatus('No inventory items found with positive quantity.', 'info');
      }
    }

    function loadItemInEntryScreen(upc) {
      // Switch to the Item Entry tab
      document.querySelector('.nav-tab[data-page="item-entry"]').click();
      
      // Set the UPC and trigger lookup
      document.getElementById('upc-input').value = upc;
      handleLookup();
      
      // Log this action
      logUserAction(`Loaded item ${upc} from inventory status`);
    }

    function exportInventoryToHTMLPDF() {
      showStatus('Generating PDF...', 'info');
      
      google.script.run
        .withSuccessHandler(function(pdfUrl) {
          if (pdfUrl) {
            window.open(pdfUrl, '_blank');
            showStatus('PDF generated successfully!', 'success');
            
            // Log this action
            logUserAction('Exported inventory status to PDF');
          } else {
            showStatus('Failed to generate PDF.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error generating PDF:', error);
          showStatus('Failed to generate PDF: ' + (error.message || error), 'error');
        })
        .exportInventoryStatusToHTMLPDF();
    }

    
// --- REVENUE FORECAST LOGIC ---
function generateRevenueForecast() {
  const startDate = document.getElementById('forecast-start-date').value;
  const endDate = document.getElementById('forecast-end-date').value;
  const forecastPeriod = document.getElementById('forecast-period').value;
  
  if (!startDate || !endDate) {
    return showStatus('Please select both start and end dates.', 'error');
  }
  
  // Show loading indicator
  document.getElementById('forecast-loading').classList.remove('hidden');
  document.getElementById('forecast-report-content').classList.add('hidden');
  showStatus('Generating revenue forecast...', 'info');
  
  // Add a safety timeout to hide the loading overlay after 10 seconds
  setTimeout(forceHideLoadingOverlays, 10000);
  
  google.script.run
    .withSuccessHandler(function(reportData) {
      // Explicitly hide loading indicator
      forceHideLoadingOverlays();
      
      console.log('Revenue forecast data received:', reportData);
      
      if (!reportData) {
        return showStatus('No data received from server. Please try again.', 'error');
      }
      
      displayRevenueForecast(reportData);
      
      // Log this action
      logUserAction('Generated revenue forecast');
    })
    .withFailureHandler(function(error) {
      // Hide loading indicator
      forceHideLoadingOverlays();
      console.error('Error generating revenue forecast:', error);
      showStatus('Error generating forecast: ' + (error.message || error), 'error');
    })
    .generateRevenueForecast(startDate, endDate, forecastPeriod);
}

function displayRevenueForecast(reportData) {
  // Make sure loading overlay is hidden
  forceHideLoadingOverlays();
  
  hideStatus();
  
  if (!reportData) {
    return showStatus('No report data received from server.', 'error');
  }
  
  if (!reportData.success) {
    return showStatus(reportData.message || 'Unknown error generating forecast.', 'error');
  }
  
  // Show the report content
  document.getElementById('forecast-report-content').classList.remove('hidden');
  
  // Update summary metrics
  document.getElementById('forecast-total-revenue').textContent = '$' + reportData.totalForecastedRevenue.toFixed(2);
  document.getElementById('forecast-daily-avg').textContent = '$' + reportData.dailyAverageRevenue.toFixed(2);
  document.getElementById('forecast-growth').textContent = reportData.growthRate.toFixed(2) + '%';
  document.getElementById('forecast-confidence').textContent = reportData.confidenceLevel.toFixed(0) + '%';
  
  // Populate monthly forecast table
  const monthlyTableBody = document.getElementById('monthly-forecast-body');
  monthlyTableBody.innerHTML = '';
  
  if (reportData.monthlyForecasts && reportData.monthlyForecasts.length > 0) {
    reportData.monthlyForecasts.forEach(month => {
      const row = document.createElement('tr');
      
      // Add appropriate class based on growth rate
      if (month.growthRate > 10) {
        row.classList.add('optimal');
      } else if (month.growthRate > 0) {
        row.classList.add('fast');
      } else if (month.growthRate > -10) {
        row.classList.add('slow');
      } else {
        row.classList.add('very-slow');
      }
      
      row.innerHTML = `
        <td>${month.month || 'N/A'}</td>
        <td>$${(month.forecastedRevenue || 0).toFixed(2)}</td>
        <td>$${(month.lowerBound || 0).toFixed(2)}</td>
        <td>$${(month.upperBound || 0).toFixed(2)}</td>
        <td>$${(month.historicalAverage || 0).toFixed(2)}</td>
        <td>${month.growthRate.toFixed(2)}%</td>
      `;
      
      monthlyTableBody.appendChild(row);
    });
  } else {
    monthlyTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No monthly forecast data available.</td></tr>';
  }
  
  // Populate product forecast table
  const productTableBody = document.getElementById('product-forecast-body');
  productTableBody.innerHTML = '';
  
  if (reportData.productForecasts && reportData.productForecasts.length > 0) {
    reportData.productForecasts.forEach(product => {
      const row = document.createElement('tr');
      
      // Determine trend icon
      let trendIcon = '→';
      if (product.trend > 10) {
        trendIcon = '↑↑';
      } else if (product.trend > 0) {
        trendIcon = '↑';
      } else if (product.trend < -10) {
        trendIcon = '↓↓';
      } else if (product.trend < 0) {
        trendIcon = '↓';
      }
      
      row.innerHTML = `
        <td>${product.name || 'N/A'}</td>
        <td>${product.category || 'N/A'}</td>
        <td>${product.historicalUnits.toFixed(2)}</td>
        <td>${product.forecastedUnits.toFixed(2)}</td>
        <td>$${(product.unitPrice || 0).toFixed(2)}</td>
        <td>$${(product.forecastedRevenue || 0).toFixed(2)}</td>
        <td>${trendIcon} ${product.trend.toFixed(2)}%</td>
      `;
      
      productTableBody.appendChild(row);
    });
  } else {
    productTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No product forecast data available.</td></tr>';
  }
  
  // Draw charts
  drawRevenueTrendChart(reportData.revenueTrend);
  drawMonthlyForecastChart(reportData.monthlyForecasts);
  drawCategoryForecastChart(reportData.categoryForecasts);
  drawWeeklyPatternChart(reportData.weeklyPattern);
  
  showStatus('Revenue forecast generated successfully!', 'success');
}

function drawRevenueTrendChart(revenueTrend) {
  if (!revenueTrend || revenueTrend.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Date');
  data.addColumn('number', 'Historical');
  data.addColumn('number', 'Forecast');
  data.addColumn({type: 'string', role: 'tooltip'});
  
  revenueTrend.forEach(point => {
    if (point.type === 'historical') {
      data.addRow([
        point.date, 
        point.revenue, 
        null, 
        `Date: ${point.date}\nRevenue: $${point.revenue.toFixed(2)}`
      ]);
    } else {
      data.addRow([
        point.date, 
        null, 
        point.revenue, 
        `Forecast: ${point.date}\nRevenue: $${point.revenue.toFixed(2)}`
      ]);
    }
  });
  
  const options = {
    title: 'Revenue Trend & Forecast',
    colors: ['#4285F4', '#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' }, 
      title: 'Revenue ($)', 
      titleTextStyle: { color: '#ffffff' },
      format: '$#,##0.00'
    },
    seriesType: 'line',
    series: {
      0: { lineWidth: 2 },
      1: { lineWidth: 2, lineDashStyle: [4, 4] }
    }
  };
  
  const chart = new google.visualization.ComboChart(document.getElementById('revenue-trend-chart'));
  chart.draw(data, options);
}

function drawMonthlyForecastChart(monthlyForecasts) {
  if (!monthlyForecasts || monthlyForecasts.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Month');
  data.addColumn('number', 'Forecasted Revenue');
  data.addColumn({id: 'min', type: 'number', role: 'interval'});
  data.addColumn({id: 'max', type: 'number', role: 'interval'});
  
  monthlyForecasts.forEach(month => {
    data.addRow([
      month.month, 
      month.forecastedRevenue, 
      month.lowerBound, 
      month.upperBound
    ]);
  });
  
  const options = {
    title: 'Monthly Revenue Forecast',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' }, 
      title: 'Revenue ($)', 
      titleTextStyle: { color: '#ffffff' },
      format: '$#,##0.00'
    },
    intervals: { style: 'area' },
    interval: {
      'min': { style: 'bars', fillOpacity: 0.1, color: '#FFD700' },
      'max': { style: 'bars', fillOpacity: 0.1, color: '#FFD700' }
    }
  };
  
  const chart = new google.visualization.ColumnChart(document.getElementById('monthly-forecast-chart'));
  chart.draw(data, options);
}

function drawCategoryForecastChart(categoryForecasts) {
  if (!categoryForecasts || categoryForecasts.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Category');
  data.addColumn('number', 'Forecasted Revenue');
  
  categoryForecasts.forEach(category => {
    data.addRow([category.name, category.forecastedRevenue]);
  });
  
  const options = {
    title: 'Top 5 Product Categories',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    pieSliceText: 'label',
    pieHole: 0.4,
    slices: {
      0: { offset: 0.1 },
      1: { offset: 0.05 }
    }
  };
  
  const chart = new google.visualization.PieChart(document.getElementById('category-forecast-chart'));
  chart.draw(data, options);
}

function drawWeeklyPatternChart(weeklyPattern) {
  if (!weeklyPattern || weeklyPattern.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Day');
  data.addColumn('number', 'Average Revenue');
  
  weeklyPattern.forEach(day => {
    data.addRow([day.name, day.averageRevenue]);
  });
  
  const options = {
    title: 'Weekly Revenue Pattern',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' }, 
      title: 'Average Revenue ($)', 
      titleTextStyle: { color: '#ffffff' },
      format: '$#,##0.00'
    }
  };
  
  const chart = new google.visualization.ColumnChart(document.getElementById('weekly-pattern-chart'));
  chart.draw(data, options);
}

function clearRevenueForecast() {
  document.getElementById('forecast-report-content').classList.add('hidden');
  document.getElementById('monthly-forecast-body').innerHTML = '';
  document.getElementById('product-forecast-body').innerHTML = '';
  hideStatus();
}

function exportRevenueForecastToHTMLPDF() {
  const startDate = document.getElementById('forecast-start-date').value;
  const endDate = document.getElementById('forecast-end-date').value;
  const forecastPeriod = document.getElementById('forecast-period').value;
  
  showStatus('Generating PDF...', 'info');
  
  google.script.run
    .withSuccessHandler(function(pdfUrl) {
      if (pdfUrl) {
        window.open(pdfUrl, '_blank');
        showStatus('PDF generated successfully!', 'success');
        
        // Log this action
        logUserAction('Exported revenue forecast to PDF');
      } else {
        showStatus('Failed to generate PDF.', 'error');
      }
    })
    .withFailureHandler(onFailure)
    .exportRevenueForecastToHTMLPDF(startDate, endDate, forecastPeriod);
}


    // --- LOGIN LOGIC ---
    function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        return showStatus('Please enter both username and password.', 'error');
      }
      
      showStatus('Logging in...', 'info');
      
      google.script.run
        .withSuccessHandler(function(isLoggedIn) {
          console.log(`Login result: ${isLoggedIn}`);
          if (isLoggedIn) {
            // Log this action
            logUserAction('Logged in');
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-portal').classList.remove('hidden');
            hideStatus();
          } else {
            showStatus('Invalid username or password.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Login error:', error);
          showStatus('An error occurred during login: ' + error, 'error');
        })
        .checkLogin(username, password);
    }
    
    function showResetMasterPasswordModalFromLogin() {
      document.getElementById('current-master-password').value = '';
      document.getElementById('new-master-password').value = '';
      document.getElementById('confirm-master-password').value = '';
      document.getElementById('reset-password-modal').style.display = 'block';
    }
    
    // --- USER MANAGEMENT FUNCTIONS ---
    function loadUsers() {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '<div class="loading-text">Loading users...</div>';
      
      google.script.run
        .withSuccessHandler(function(users) {
          if (!users || users.length === 0) {
            userList.innerHTML = '<div class="loading-text">No users found.</div>';
            return;
          }
          
          let html = '';
          users.forEach(user => {
            html += `
              <div class="user-item">
                <div class="user-name">${user}</div>
                <div class="user-actions">
                  <button onclick="showDeleteUserModal('${user}')" class="btn-danger">Delete</button>
                </div>
              </div>
            `;
          });
          
          userList.innerHTML = html;
        })
        .withFailureHandler(function(error) {
          userList.innerHTML = `<div class="loading-text error">Error loading users: ${error}</div>`;
        })
        .getUsers();
    }
    
    function showAddUserModal() {
      document.getElementById('master-password-add').value = '';
      document.getElementById('new-username').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
      document.getElementById('add-user-modal').style.display = 'block';
    }
    
    function showDeleteUserModal(username) {
      document.getElementById('delete-username').textContent = username;
      document.getElementById('username-to-delete').value = username;
      document.getElementById('master-password-delete').value = '';
      document.getElementById('delete-user-modal').style.display = 'block';
    }
    
    function showResetMasterPasswordModal() {
      document.getElementById('current-master-password').value = '';
      document.getElementById('new-master-password').value = '';
      document.getElementById('confirm-master-password').value = '';
      document.getElementById('reset-password-modal').style.display = 'block';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    function addUser() {
      const masterPassword = document.getElementById('master-password-add').value;
      const username = document.getElementById('new-username').value;
      const password = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (!masterPassword || !username || !password || !confirmPassword) {
        return showStatus('Please fill in all fields.', 'error');
      }
      
      if (password !== confirmPassword) {
        return showStatus('Passwords do not match.', 'error');
      }
      
      showStatus('Adding user...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            closeModal('add-user-modal');
            loadUsers();
            
            // Log this action
            logUserAction(`Added user: ${username}`);
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(onFailure)
        .addUser(masterPassword, username, password);
    }
    
    function deleteUser() {
      const masterPassword = document.getElementById('master-password-delete').value;
      const username = document.getElementById('username-to-delete').value;
      
      if (!masterPassword || !username) {
        return showStatus('Please enter the master password.', 'error');
      }
      
      showStatus('Deleting user...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            closeModal('delete-user-modal');
            loadUsers();
            
            // Log this action
            logUserAction(`Deleted user: ${username}`);
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(onFailure)
        .deleteUser(masterPassword, username);
    }
    
    function resetMasterPassword() {
      const currentPassword = document.getElementById('current-master-password').value;
      const newPassword = document.getElementById('new-master-password').value;
      const confirmPassword = document.getElementById('confirm-master-password').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        return showStatus('Please fill in all fields.', 'error');
      }
      
      if (newPassword !== confirmPassword) {
        return showStatus('New passwords do not match.', 'error');
      }
      
      showStatus('Resetting master password...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            closeModal('reset-password-modal');
            
            // Log this action
            logUserAction('Reset master password');
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(onFailure)
        .resetMasterPassword(currentPassword, newPassword);
    }
    
    // --- CREDENTIALS FUNCTIONS ---
    function authenticateCredentials() {
      const masterPassword = document.getElementById('credentials-master-password').value;
      
      if (!masterPassword) {
        return showStatus('Please enter the master password.', 'error');
      }
      
      showStatus('Verifying password...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            // Hide the auth form and show the credentials
            document.getElementById('credentials-auth-form').classList.add('hidden');
            document.getElementById('credentials-container').classList.remove('hidden');
            document.getElementById('save-credentials-btn').classList.remove('hidden');
            document.getElementById('refresh-credentials-btn').classList.remove('hidden');
            
            // Display the credentials
            displayCredentials(result.credentials);
            
            hideStatus();
          } else {
            showStatus(result.message || 'Authentication failed.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error authenticating: ' + error, 'error');
        })
        .getCredentialsWithAuth(masterPassword);
    }

    function loadCredentialsWithAuth() {
      const masterPassword = document.getElementById('credentials-master-password').value;
      
      if (!masterPassword) {
        return showStatus('Please enter the master password.', 'error');
      }
      
      showStatus('Refreshing credentials...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            displayCredentials(result.credentials);
            showStatus('Credentials refreshed successfully.', 'success');
          } else {
            showStatus(result.message || 'Failed to refresh credentials.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error refreshing credentials: ' + error, 'error');
        })
        .getCredentialsWithAuth(masterPassword);
    }

    // --- EXPIRATION TRACKING LOGIC ---
    function loadExpirationData() {
      // Show loading indicator
      document.getElementById('expiration-loading').classList.remove('hidden');
      showStatus('Loading expiration data...', 'info');
      
      // Get filter values
      const expirationFilter = document.getElementById('expiration-filter').value;
      const categoryFilter = document.getElementById('category-filter').value;
      
      google.script.run
        .withSuccessHandler(function(expirationData) {
          // Hide loading indicator
          document.getElementById('expiration-loading').classList.add('hidden');
          
          console.log('Expiration data received:', expirationData);
          
          if (!expirationData) {
            return showStatus('No data received from server. Please try again.', 'error');
          }
          
          displayExpirationData(expirationData, expirationFilter, categoryFilter);
          
          // Log this action
          logUserAction('Viewed expiration tracking');
        })
        .withFailureHandler(function(error) {
          // Hide loading indicator
          document.getElementById('expiration-loading').classList.add('hidden');
          console.error('Error loading expiration data:', error);
          showStatus('Error loading expiration data: ' + (error.message || error), 'error');
        })
        .getExpirationData();
    }

    function displayExpirationData(expirationData, expirationFilter, categoryFilter) {
      hideStatus();
      
      if (!expirationData) {
        return showStatus('No expiration data received from server.', 'error');
      }
      
      if (!expirationData.success) {
        return showStatus(expirationData.message || 'Unknown error loading expiration data.', 'error');
      }
      
      // Update summary counts
      document.getElementById('expired-count').textContent = expirationData.expiredCount || 0;
      document.getElementById('expiring-7-count').textContent = expirationData.expiring7Count || 0;
      document.getElementById('expiring-30-count').textContent = expirationData.expiring30Count || 0;
      document.getElementById('expiring-90-count').textContent = expirationData.expiring90Count || 0;
      
      // Filter items based on selected filters
      let filteredItems = expirationData.items;
      
      // Apply expiration filter
      if (expirationFilter !== 'all') {
        switch (expirationFilter) {
          case 'expired':
            filteredItems = filteredItems.filter(item => item.daysLeft <= 0);
            break;
          case '7days':
            filteredItems = filteredItems.filter(item => item.daysLeft > 0 && item.daysLeft <= 7);
            break;
          case '30days':
            filteredItems = filteredItems.filter(item => item.daysLeft > 7 && item.daysLeft <= 30);
            break;
          case '90days':
            filteredItems = filteredItems.filter(item => item.daysLeft > 30 && item.daysLeft <= 90);
            break;
        }
      }
      
      // Apply category filter
      if (categoryFilter !== 'all') {
        filteredItems = filteredItems.filter(item => item.category === categoryFilter);
      }
      
      // Populate expiration table
      const tableBody = document.getElementById('expiration-body');
      tableBody.innerHTML = '';
      
      if (filteredItems && filteredItems.length > 0) {
        filteredItems.forEach(item => {
          const row = document.createElement('tr');
          
          // Add appropriate class based on expiration status
          if (item.daysLeft <= 0) {
            row.classList.add('expired');
          } else if (item.daysLeft <= 7) {
            row.classList.add('expiring-7days');
          } else if (item.daysLeft <= 30) {
            row.classList.add('expiring-30days');
          } else if (item.daysLeft <= 90) {
            row.classList.add('expiring-90days');
          }
          
          // Format the status text
          let statusText = '';
          if (item.daysLeft <= 0) {
            statusText = 'EXPIRED';
          } else if (item.daysLeft === 1) {
            statusText = 'EXPIRES TOMORROW';
          } else {
            statusText = `EXPIRES IN ${item.daysLeft} DAYS`;
          }
          
          row.innerHTML = `
            <td>${item.upc || 'N/A'}</td>
            <td>${item.brand || 'N/A'}</td>
            <td>${item.name || 'N/A'}</td>
            <td>${item.category || 'N/A'}</td>
            <td>${item.quantity || '0'}</td>
            <td>${item.expDate || 'N/A'}</td>
            <td>${item.daysLeft <= 0 ? 'EXPIRED' : item.daysLeft}</td>
            <td>${statusText}</td>
            <td>
              <input type="checkbox" class="item-checkbox" data-upc="${item.upc}" data-name="${item.name}" data-qty="${item.quantity}">
              <button onclick="loadItemInEntryScreen('${item.upc}')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px;">Edit</button>
            </td>
          `;
          
          tableBody.appendChild(row);
        });
        
        showStatus('Expiration data loaded successfully!', 'success');
      } else {
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No items found matching the selected filters.</td></tr>';
        showStatus('No items found matching the selected filters.', 'info');
      }
      
      // Populate category filter if needed
      if (expirationData.categories && expirationData.categories.length > 0) {
        const categorySelect = document.getElementById('category-filter');
        
        // Save current selection
        const currentSelection = categorySelect.value;
        
        // Clear existing options except the first one
        while (categorySelect.options.length > 1) {
          categorySelect.remove(1);
        }
        
        // Add new options
        expirationData.categories.forEach(category => {
          if (category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
          }
        });
        
        // Restore selection if possible
        if (currentSelection && Array.from(categorySelect.options).some(opt => opt.value === currentSelection)) {
          categorySelect.value = currentSelection;
        }
      }
    }

    function showMarkLossModal() {
      // Get selected items
      const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
      
      if (selectedCheckboxes.length === 0) {
        return showStatus('Please select at least one item to mark as loss.', 'warning');
      }
      
      // Populate the modal with selected items
      const lossItemsList = document.getElementById('loss-items-list');
      lossItemsList.innerHTML = '';
      
      selectedCheckboxes.forEach(checkbox => {
        const upc = checkbox.getAttribute('data-upc');
        const name = checkbox.getAttribute('data-name');
        const qty = checkbox.getAttribute('data-qty');
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'loss-item';
        itemDiv.innerHTML = `
          <div><strong>${name}</strong> (UPC: ${upc})</div>
          <div class="row" style="margin-top: 5px; margin-bottom: 15px;">
            <div class="col">
              <label for="loss-qty-${upc}">Quantity to Remove:</label>
              <input type="number" id="loss-qty-${upc}" min="1" max="${qty}" value="${qty}" class="loss-qty" data-upc="${upc}">
            </div>
          </div>
        `;
        
        lossItemsList.appendChild(itemDiv);
      });
      
      // Show the modal
      document.getElementById('mark-loss-modal').style.display = 'block';
    }

    function recordLoss() {
      // Get loss details
      const reason = document.getElementById('loss-reason').value;
      const notes = document.getElementById('loss-notes').value;
      
      // Get quantities for each item
      const lossItems = [];
      document.querySelectorAll('.loss-qty').forEach(input => {
        lossItems.push({
          upc: input.getAttribute('data-upc'),
          quantity: parseInt(input.value) || 0
        });
      });
      
      if (lossItems.length === 0) {
        return showStatus('No items selected for loss recording.', 'error');
      }
      
      showStatus('Recording inventory loss...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message || 'Inventory loss recorded successfully!', 'success');
            closeModal('mark-loss-modal');
            
            // Refresh the expiration data
            loadExpirationData();
            
            // Log this action
            logUserAction('Recorded inventory loss: ' + reason);
          } else {
            showStatus(result.message || 'Failed to record inventory loss.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error recording loss:', error);
          showStatus('Error recording loss: ' + (error.message || error), 'error');
        })
        .recordInventoryLoss(lossItems, reason, notes);
    }

    function exportExpirationToHTMLPDF() {
      showStatus('Generating PDF...', 'info');
      
      // Get filter values
      const expirationFilter = document.getElementById('expiration-filter').value;
      const categoryFilter = document.getElementById('category-filter').value;
      
      google.script.run
        .withSuccessHandler(function(pdfUrl) {
          if (pdfUrl) {
            window.open(pdfUrl, '_blank');
            showStatus('PDF generated successfully!', 'success');
            
            // Log this action
            logUserAction('Exported expiration report to PDF');
          } else {
            showStatus('Failed to generate PDF.', 'error');
          }
        })
        .withFailureHandler(onFailure)
        .exportExpirationReportToHTMLPDF(expirationFilter, categoryFilter);
    }
    function displayCredentials(credentials) {
      const container = document.getElementById('credentials-container');
      
      if (!credentials || credentials.length === 0) {
        container.innerHTML = '<div class="loading-text">No credentials found.</div>';
        return;
      }
      
      let html = '';
      let currentSection = '';
      
      credentials.forEach(cred => {
        if (cred.section !== currentSection) {
          if (currentSection !== '') {
            html += '</div>'; // Close previous section
          }
          currentSection = cred.section;
          html += `<div class="credential-section"><h3>${currentSection}</h3>`;
        }
        
        html += `
          <div class="credential-item">
            <div class="credential-label">${cred.label}</div>
        `;
        
        if (cred.editable) {
          html += `<input type="text" class="credential-value editable" id="cred-${cred.id}" value="${cred.value}" data-id="${cred.id}">`;
        } else {
          html += `<div class="credential-value">${cred.value}</div>`;
        }
        
        html += `</div>`;
      });
      
      if (currentSection !== '') {
        html += '</div>'; // Close last section
      }
      
      container.innerHTML = html;
    }

    function loadCredentials() {
      // Reset the credentials page
      document.getElementById('credentials-auth-form').classList.remove('hidden');
      document.getElementById('credentials-container').classList.add('hidden');
      document.getElementById('save-credentials-btn').classList.add('hidden');
      document.getElementById('refresh-credentials-btn').classList.add('hidden');
      document.getElementById('credentials-master-password').value = '';
    }

    function saveCredentials() {
      const credentialInputs = document.querySelectorAll('.credential-value.editable');
      const credentials = [];
      
      credentialInputs.forEach(input => {
        credentials.push({
          id: input.getAttribute('data-id'),
          value: input.value
        });
      });
      
      const masterPassword = document.getElementById('credentials-master-password').value;
      
      if (!masterPassword) {
        return showStatus('Master password is required to save changes.', 'error');
      }
      
      showStatus('Saving credentials...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            
            // Log this action
            logUserAction('Updated system credentials');
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(onFailure)
        .saveCredentialsWithAuth(masterPassword, credentials);
    }

    // --- LOGGING FUNCTION ---
    function logUserAction(description) {
      const username = document.getElementById('username').value;
      
      google.script.run
        .withFailureHandler(function(error) {
          console.error('Error logging user action:', error);
        })
        .logUserAction(username, description);
    }

    // --- ITEM ENTRY LOGIC ---
    function handleLookup() {
      const upc = document.getElementById('upc-input').value.trim();
      if (!upc) { 
        return showStatus('Please enter a UPC code.', 'error');
      }
      
      showStatus('Looking up product...', 'info');
      
      google.script.run
        .withSuccessHandler(function(product) {
          if (product) {
            populateForm(product);
            showStatus('Product found!', 'success');
            
            // Log this action
            logUserAction(`Looked up product: ${upc}`);
          } else {
            clearForm();
            document.getElementById('upc-input').value = upc;
            showStatus('Product not found. Please enter details manually.', 'warning');
          }
        })
        .withFailureHandler(onFailure)
        .lookupProduct(upc);
    }
    
    function handleRequestInfo() {
      const upc = document.getElementById('upc-input').value.trim();
      if (!upc) {
        return showStatus('Please enter a UPC code.', 'error');
      }
      
      showStatus('Requesting product information...', 'info');
      
      google.script.run
        .withSuccessHandler(function(product) {
          if (product) {
            populateForm(product);
            showStatus('Product information retrieved!', 'success');
            
            // Log this action
            logUserAction(`Requested info for product: ${upc}`);
          } else {
            showStatus('Could not retrieve product information. Please enter details manually.', 'warning');
          }
        })
        .withFailureHandler(onFailure)
        .requestProductInfo(upc);
    }
    
    function populateForm(product) {
      document.getElementById('upc-input').value = product.upc || '';
      document.getElementById('brand').value = product.brand || '';
      document.getElementById('name').value = product.name || '';
      document.getElementById('category').value = product.category || '';
      document.getElementById('details').value = product.details || '';
      document.getElementById('size').value = product.size || '';
      document.getElementById('image').value = product.image || '';
      document.getElementById('calories').value = product.calories || '';
      document.getElementById('sugar').value = product.sugar || '';
      document.getElementById('sodium').value = product.sodium || '';
      document.getElementById('price').value = product.price || '';
      document.getElementById('taxable').value = product.taxable || 'Yes';
      document.getElementById('cost').value = product.cost || '';
      document.getElementById('purchaseUnitQty').value = product.purchaseUnitQty || '';
      document.getElementById('qty').value = product.qty || '';
      document.getElementById('expDate').value = product.expDate || '';
      
      calculateDerivedValues();
    }
    
    function calculateDerivedValues() {
      const price = parseFloat(document.getElementById('price').value) || 0;
      const cost = parseFloat(document.getElementById('cost').value) || 0;
      const purchaseUnitQty = parseInt(document.getElementById('purchaseUnitQty').value) || 1;
      
      const indvCost = cost / purchaseUnitQty;
      const profit = price - indvCost;
      
      document.getElementById('indvCost').value = indvCost.toFixed(2);
      document.getElementById('profit').value = profit.toFixed(2);
    }
    
    function handleSave() {
      const product = {
        upc: document.getElementById('upc-input').value.trim(),
        brand: document.getElementById('brand').value.trim(),
        name: document.getElementById('name').value.trim(),
        category: document.getElementById('category').value.trim(),
        details: document.getElementById('details').value.trim(),
        size: document.getElementById('size').value.trim(),
        image: document.getElementById('image').value.trim(),
        calories: document.getElementById('calories').value.trim(),
        sugar: document.getElementById('sugar').value.trim(),
        sodium: document.getElementById('sodium').value.trim(),
        price: parseFloat(document.getElementById('price').value) || 0,
        taxable: document.getElementById('taxable').value,
        cost: parseFloat(document.getElementById('cost').value) || 0,
        purchaseUnitQty: parseInt(document.getElementById('purchaseUnitQty').value) || 1,
        qty: parseInt(document.getElementById('qty').value) || 0,
        expDate: document.getElementById('expDate').value
      };
      
      if (!product.upc) {
        return showStatus('UPC is required.', 'error');
      }
      
      if (!product.name) {
        return showStatus('Product name is required.', 'error');
      }
      
      showStatus('Saving product...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            
            // Log this action
            logUserAction(`Saved product: ${product.upc} - ${product.name}`);
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(onFailure)
        .saveProduct(product);
    }
    
    function handleClear() {
      clearForm();
      showStatus('Form cleared.', 'info');
    }
    
    function clearForm() {
      document.getElementById('upc-input').value = '';
      document.getElementById('brand').value = '';
      document.getElementById('name').value = '';
      document.getElementById('category').value = '';
      document.getElementById('details').value = '';
      document.getElementById('size').value = '';
      document.getElementById('image').value = '';
      document.getElementById('calories').value = '';
      document.getElementById('sugar').value = '';
      document.getElementById('sodium').value = '';
      document.getElementById('price').value = '';
      document.getElementById('taxable').value = 'Yes';
      document.getElementById('cost').value = '';
      document.getElementById('purchaseUnitQty').value = '';
      document.getElementById('indvCost').value = '';
      document.getElementById('profit').value = '';
      document.getElementById('qty').value = '';
      document.getElementById('expDate').value = '';
    }
    
    // --- SALES REPORT LOGIC ---
    function generateSalesReport() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      if (!startDate || !endDate) {
        return showStatus('Please select both start and end dates.', 'error');
      }
      
      // Show loading indicator
      document.getElementById('sales-loading').classList.remove('hidden');
      document.getElementById('report-content').classList.add('hidden');
      showStatus('Generating sales report...', 'info');
      
      // Add a safety timeout to hide the loading overlay after 10 seconds
      setTimeout(forceHideLoadingOverlays, 10000);
      
      google.script.run
        .withSuccessHandler(function(reportData) {
          // Explicitly hide loading indicator
          forceHideLoadingOverlays();
          
          console.log('Report data received:', reportData);
          
          if (!reportData) {
            return showStatus('No data received from server. Please try again.', 'error');
          }
          
          displaySalesReport(reportData);
          
          // Log this action
          logUserAction('Generated sales report');
        })
        .withFailureHandler(function(error) {
          // Hide loading indicator
          forceHideLoadingOverlays();
          console.error('Error generating report:', error);
          showStatus('Error generating report: ' + (error.message || error), 'error');
        })
        .generateSalesReport(startDate, endDate);
    }

    function displaySalesReport(reportData) {
      // Make sure loading overlay is hidden
      forceHideLoadingOverlays();
      
      hideStatus();
      
      if (!reportData) {
        return showStatus('No report data received from server.', 'error');
      }
      
      if (!reportData.success) {
        return showStatus(reportData.message || 'Unknown error generating report.', 'error');
      }
      
      // Show the report content
      document.getElementById('report-content').classList.remove('hidden');
      
      // Update summary metrics
      document.getElementById('total-transactions').textContent = reportData.totalTransactions;
      document.getElementById('total-items').textContent = reportData.totalItems;
      document.getElementById('total-subtotal').textContent = '$' + reportData.totalSubtotal.toFixed(2);
      document.getElementById('total-tax').textContent = '$' + reportData.totalTax.toFixed(2);
      document.getElementById('total-revenue').textContent = '$' + reportData.totalRevenue.toFixed(2);
      
      // Populate transactions table
      const tableBody = document.getElementById('transactions-body');
      tableBody.innerHTML = '';
      
      if (reportData.transactions && reportData.transactions.length > 0) {
        reportData.transactions.forEach(transaction => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${transaction.id || 'N/A'}</td>
            <td>${transaction.date || 'N/A'}</td>
            <td>${transaction.time || 'N/A'}</td>
            <td>${transaction.items || '0'}</td>
            <td>${transaction.paymentMethod || 'N/A'}</td>
            <td>$${(transaction.subtotal || 0).toFixed(2)}</td>
            <td>$${(transaction.tax || 0).toFixed(2)}</td>
            <td>$${(transaction.total || 0).toFixed(2)}</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        showStatus('Report generated successfully!', 'success');
      } else {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No transactions found in the selected date range.</td></tr>';
        showStatus('No transactions found in the selected date range.', 'info');
      }
    }

    function clearReport() {
      document.getElementById('report-content').classList.add('hidden');
      document.getElementById('transactions-body').innerHTML = '';
      hideStatus();
    }

    function exportToHTMLPDF() {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      showStatus('Generating PDF...', 'info');
      
      google.script.run
        .withSuccessHandler(function(pdfUrl) {
          if (pdfUrl) {
            window.open(pdfUrl, '_blank');
            showStatus('PDF generated successfully!', 'success');
            
            // Log this action
            logUserAction('Exported sales report to PDF');
          } else {
            showStatus('Failed to generate PDF.', 'error');
          }
        })
        .withFailureHandler(onFailure)
        .exportSalesReportToHTMLPDF(startDate, endDate);
    }

// --- COST ANALYSIS REPORT LOGIC ---
function generateCostAnalysisReport() {
  const startDate = document.getElementById('cost-start-date').value;
  const endDate = document.getElementById('cost-end-date').value;
  const category = document.getElementById('cost-category-filter').value;
  
  if (!startDate || !endDate) {
    return showStatus('Please select both start and end dates.', 'error');
  }
  
  // Show loading indicator
  document.getElementById('cost-loading').classList.remove('hidden');
  document.getElementById('cost-report-content').classList.add('hidden');
  showStatus('Generating cost analysis report...', 'info');
  
  // Add a safety timeout to hide the loading overlay after 10 seconds
  setTimeout(forceHideLoadingOverlays, 10000);
  
  google.script.run
    .withSuccessHandler(function(reportData) {
      // Explicitly hide loading indicator
      forceHideLoadingOverlays();
      
      console.log('Cost analysis report data received:', reportData);
      
      if (!reportData) {
        return showStatus('No data received from server. Please try again.', 'error');
      }
      
      displayCostAnalysisReport(reportData);
      
      // Log this action
      logUserAction('Generated cost analysis report');
    })
    .withFailureHandler(function(error) {
      // Hide loading indicator
      forceHideLoadingOverlays();
      console.error('Error generating cost analysis report:', error);
      showStatus('Error generating report: ' + (error.message || error), 'error');
    })
    .generateCostAnalysisReport(startDate, endDate, category);
}

function displayCostAnalysisReport(reportData) {
  // Make sure loading overlay is hidden
  forceHideLoadingOverlays();
  
  hideStatus();
  
  if (!reportData) {
    return showStatus('No report data received from server.', 'error');
  }
  
  if (!reportData.success) {
    return showStatus(reportData.message || 'Unknown error generating report.', 'error');
  }
  
  // Show the report content
  document.getElementById('cost-report-content').classList.remove('hidden');
  
  // Update summary metrics
  document.getElementById('total-inventory-cost').textContent = '$' + reportData.totalInventoryCost.toFixed(2);
  document.getElementById('avg-item-cost').textContent = '$' + reportData.averageItemCost.toFixed(2);
  document.getElementById('highest-cost-item').textContent = reportData.highestCostItem || 'N/A';
  document.getElementById('lowest-cost-item').textContent = reportData.lowestCostItem || 'N/A';
  
  // Populate category cost table
  const categoryTableBody = document.getElementById('category-cost-body');
  categoryTableBody.innerHTML = '';
  
  if (reportData.categoryCosts && reportData.categoryCosts.length > 0) {
    reportData.categoryCosts.forEach(category => {
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${category.name || 'N/A'}</td>
        <td>${category.itemCount || '0'}</td>
        <td>$${(category.totalCost || 0).toFixed(2)}</td>
        <td>$${(category.avgCost || 0).toFixed(2)}</td>
        <td>${category.percentOfTotal.toFixed(2)}%</td>
      `;
      
      categoryTableBody.appendChild(row);
    });
  } else {
    categoryTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No category data available.</td></tr>';
  }
  
  // Populate detailed cost table
  const costTableBody = document.getElementById('cost-body');
  costTableBody.innerHTML = '';
  
  if (reportData.items && reportData.items.length > 0) {
    reportData.items.forEach(item => {
      const row = document.createElement('tr');
      
      // Add appropriate class based on days in inventory
      if (item.daysInInventory > 90) {
        row.classList.add('very-slow');
      } else if (item.daysInInventory > 60) {
        row.classList.add('slow');
      } else if (item.daysInInventory < 7) {
        row.classList.add('fast');
      }
      
      row.innerHTML = `
        <td>${item.upc || 'N/A'}</td>
        <td>${item.name || 'N/A'}</td>
        <td>${item.category || 'N/A'}</td>
        <td>${item.quantity || '0'}</td>
        <td>$${(item.unitCost || 0).toFixed(2)}</td>
        <td>$${(item.totalCost || 0).toFixed(2)}</td>
        <td>${item.lastSold || 'Never'}</td>
        <td>${item.daysInInventory || '0'}</td>
      `;
      
      costTableBody.appendChild(row);
    });
    
    // Draw charts
    drawCategoryCostChart(reportData.categoryCosts);
    drawTopCostChart(reportData.topCostItems);
    
    showStatus('Cost analysis report generated successfully!', 'success');
  } else {
    costTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No items found in the selected date range.</td></tr>';
    showStatus('No items found in the selected date range.', 'info');
  }
  
  // Populate category filter if needed
  if (reportData.categories && reportData.categories.length > 0) {
    const categorySelect = document.getElementById('cost-category-filter');
    
    // Save current selection
    const currentSelection = categorySelect.value;
    
    // Clear existing options except the first one
    while (categorySelect.options.length > 1) {
      categorySelect.remove(1);
    }
    
    // Add new options
    reportData.categories.forEach(category => {
      if (category) {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      }
    });
    
    // Restore selection if possible
    if (currentSelection && Array.from(categorySelect.options).some(opt => opt.value === currentSelection)) {
      categorySelect.value = currentSelection;
    }
  }
}

function drawCategoryCostChart(categoryCosts) {
  if (!categoryCosts || categoryCosts.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Category');
  data.addColumn('number', 'Total Cost');
  
  categoryCosts.forEach(category => {
    data.addRow([category.name, category.totalCost]);
  });
  
  const options = {
    title: 'Cost Distribution by Category',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' }, 
      title: 'Total Cost ($)', 
      titleTextStyle: { color: '#ffffff' },
      format: '$#,##0.00'
    }
  };
  
  const chart = new google.visualization.PieChart(document.getElementById('category-cost-chart'));
  chart.draw(data, options);
}

function drawTopCostChart(topCostItems) {
  if (!topCostItems || topCostItems.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Product');
  data.addColumn('number', 'Unit Cost');
  
  topCostItems.forEach(item => {
    data.addRow([item.name, item.unitCost]);
  });
  
  const options = {
    title: 'Top Items by Unit Cost',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' },
      format: '$#,##0.00'
    }
  };
  
  const chart = new google.visualization.BarChart(document.getElementById('top-cost-chart'));
  chart.draw(data, options);
}

function clearCostAnalysisReport() {
  document.getElementById('cost-report-content').classList.add('hidden');
  document.getElementById('cost-body').innerHTML = '';
  document.getElementById('category-cost-body').innerHTML = '';
  hideStatus();
}

function exportCostAnalysisReportToHTMLPDF() {
  const startDate = document.getElementById('cost-start-date').value;
  const endDate = document.getElementById('cost-end-date').value;
  const category = document.getElementById('cost-category-filter').value;
  
  showStatus('Generating PDF...', 'info');
  
  google.script.run
    .withSuccessHandler(function(pdfUrl) {
      if (pdfUrl) {
        window.open(pdfUrl, '_blank');
        showStatus('PDF generated successfully!', 'success');
        
        // Log this action
        logUserAction('Exported cost analysis report to PDF');
      } else {
        showStatus('Failed to generate PDF.', 'error');
      }
    })
    .withFailureHandler(onFailure)
    .exportCostAnalysisReportToHTMLPDF(startDate, endDate, category);
}



    // --- PROFIT MARGIN REPORT LOGIC ---
function generateProfitMarginReport() {
  const startDate = document.getElementById('profit-start-date').value;
  const endDate = document.getElementById('profit-end-date').value;
  const category = document.getElementById('profit-category-filter').value;
  
  if (!startDate || !endDate) {
    return showStatus('Please select both start and end dates.', 'error');
  }
  
  // Show loading indicator
  document.getElementById('profit-loading').classList.remove('hidden');
  document.getElementById('profit-report-content').classList.add('hidden');
  showStatus('Generating profit margin report...', 'info');
  
  // Add a safety timeout to hide the loading overlay after 10 seconds
  setTimeout(forceHideLoadingOverlays, 10000);
  
  google.script.run
    .withSuccessHandler(function(reportData) {
      // Explicitly hide loading indicator
      forceHideLoadingOverlays();
      
      console.log('Profit margin report data received:', reportData);
      
      if (!reportData) {
        return showStatus('No data received from server. Please try again.', 'error');
      }
      
      displayProfitMarginReport(reportData);
      
      // Log this action
      logUserAction('Generated profit margin report');
    })
    .withFailureHandler(function(error) {
      // Hide loading indicator
      forceHideLoadingOverlays();
      console.error('Error generating profit margin report:', error);
      showStatus('Error generating report: ' + (error.message || error), 'error');
    })
    .generateProfitMarginReport(startDate, endDate, category);
}

function displayProfitMarginReport(reportData) {
  // Make sure loading overlay is hidden
  forceHideLoadingOverlays();
  
  hideStatus();
  
  if (!reportData) {
    return showStatus('No report data received from server.', 'error');
  }
  
  if (!reportData.success) {
    return showStatus(reportData.message || 'Unknown error generating report.', 'error');
  }
  
  // Show the report content
  document.getElementById('profit-report-content').classList.remove('hidden');
  
  // Update summary metrics
  document.getElementById('avg-margin-percent').textContent = reportData.averageMarginPercent.toFixed(2) + '%';
  document.getElementById('total-revenue').textContent = '$' + reportData.totalRevenue.toFixed(2);
  document.getElementById('total-cost').textContent = '$' + reportData.totalCost.toFixed(2);
  document.getElementById('total-profit').textContent = '$' + reportData.totalProfit.toFixed(2);
  
  // Populate margin table
  const tableBody = document.getElementById('margin-body');
  tableBody.innerHTML = '';
  
  if (reportData.products && reportData.products.length > 0) {
    reportData.products.forEach(product => {
      const row = document.createElement('tr');
      
      // Add appropriate class based on margin percentage
      if (product.marginPercent >= 50) {
        row.classList.add('optimal');
      } else if (product.marginPercent >= 30) {
        row.classList.add('fast');
      } else if (product.marginPercent >= 15) {
        row.classList.add('slow');
      } else {
        row.classList.add('very-slow');
      }
      
      row.innerHTML = `
        <td>${product.upc || 'N/A'}</td>
        <td>${product.name || 'N/A'}</td>
        <td>${product.category || 'N/A'}</td>
        <td>${product.quantity || '0'}</td>
        <td>$${(product.price || 0).toFixed(2)}</td>
        <td>$${(product.cost || 0).toFixed(2)}</td>
        <td>$${(product.revenue || 0).toFixed(2)}</td>
        <td>$${(product.totalCost || 0).toFixed(2)}</td>
        <td>$${(product.profit || 0).toFixed(2)}</td>
        <td>${product.marginPercent.toFixed(2)}%</td>
      `;
      
      tableBody.appendChild(row);
    });
    
    // Draw charts
    drawCategoryMarginChart(reportData.categoryMargins);
    drawTopMarginChart(reportData.topMarginProducts);
    
    showStatus('Profit margin report generated successfully!', 'success');
  } else {
    tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No products found in the selected date range.</td></tr>';
    showStatus('No products found in the selected date range.', 'info');
  }
  
  // Populate category filter if needed
  if (reportData.categories && reportData.categories.length > 0) {
    const categorySelect = document.getElementById('profit-category-filter');
    
    // Save current selection
    const currentSelection = categorySelect.value;
    
    // Clear existing options except the first one
    while (categorySelect.options.length > 1) {
      categorySelect.remove(1);
    }
    
    // Add new options
    reportData.categories.forEach(category => {
      if (category) {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      }
    });
    
    // Restore selection if possible
    if (currentSelection && Array.from(categorySelect.options).some(opt => opt.value === currentSelection)) {
      categorySelect.value = currentSelection;
    }
  }
}

function drawCategoryMarginChart(categoryMargins) {
  if (!categoryMargins || categoryMargins.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Category');
  data.addColumn('number', 'Margin %');
  
  categoryMargins.forEach(item => {
    data.addRow([item.category, item.marginPercent]);
  });
  
  const options = {
    title: 'Profit Margin by Category',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' }, 
      title: 'Margin %', 
      titleTextStyle: { color: '#ffffff' },
      format: '#.##\'%\''
    }
  };
  
  const chart = new google.visualization.ColumnChart(document.getElementById('category-margin-chart'));
  chart.draw(data, options);
}

function drawTopMarginChart(topProducts) {
  if (!topProducts || topProducts.length === 0) return;
  
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Product');
  data.addColumn('number', 'Margin %');
  
  topProducts.forEach(product => {
    data.addRow([product.name, product.marginPercent]);
  });
  
  const options = {
    title: 'Top Products by Margin',
    colors: ['#FFD700'],
    backgroundColor: { fill:'transparent' },
    titleTextStyle: { color: '#FFD700' },
    legend: { textStyle: { color: '#ffffff' } },
    hAxis: { textStyle: { color: '#ffffff' } },
    vAxis: { 
      textStyle: { color: '#ffffff' },
      format: '#.##\'%\''
    }
  };
  
  const chart = new google.visualization.BarChart(document.getElementById('top-margin-chart'));
  chart.draw(data, options);
}

function clearProfitMarginReport() {
  document.getElementById('profit-report-content').classList.add('hidden');
  document.getElementById('margin-body').innerHTML = '';
  hideStatus();
}

function exportProfitMarginReportToHTMLPDF() {
  const startDate = document.getElementById('profit-start-date').value;
  const endDate = document.getElementById('profit-end-date').value;
  const category = document.getElementById('profit-category-filter').value;
  
  showStatus('Generating PDF...', 'info');
  
  google.script.run
    .withSuccessHandler(function(pdfUrl) {
      if (pdfUrl) {
        window.open(pdfUrl, '_blank');
        showStatus('PDF generated successfully!', 'success');
        
        // Log this action
        logUserAction('Exported profit margin report to PDF');
      } else {
        showStatus('Failed to generate PDF.', 'error');
      }
    })
    .withFailureHandler(onFailure)
    .exportProfitMarginReportToHTMLPDF(startDate, endDate, category);
}


    // --- PRODUCT REPORT LOGIC ---
    function generateProductReport() {
      const startDate = document.getElementById('product-start-date').value;
      const endDate = document.getElementById('product-end-date').value;
      
      if (!startDate || !endDate) {
        return showStatus('Please select both start and end dates.', 'error');
      }
      
      // Show loading indicator
      document.getElementById('product-loading').classList.remove('hidden');
      document.getElementById('product-report-content').classList.add('hidden');
      showStatus('Generating product performance report...', 'info');
      
      // Add a safety timeout to hide the loading overlay after 10 seconds
      setTimeout(forceHideLoadingOverlays, 10000);
      
      google.script.run
        .withSuccessHandler(function(reportData) {
          // Explicitly hide loading indicator
          forceHideLoadingOverlays();
          
          console.log('Product report data received:', reportData);
          
          if (!reportData) {
            return showStatus('No data received from server. Please try again.', 'error');
          }
          
          displayProductReport(reportData);
          
          // Log this action
          logUserAction('Generated product performance report');
        })
        .withFailureHandler(function(error) {
          // Hide loading indicator
          forceHideLoadingOverlays();
          console.error('Error generating product report:', error);
          showStatus('Error generating product report: ' + (error.message || error), 'error');
        })
        .generateProductPerformanceReport(startDate, endDate);
    }

    function displayProductReport(reportData) {
      // Make sure loading overlay is hidden
      forceHideLoadingOverlays();
      
      hideStatus();
      
      if (!reportData) {
        return showStatus('No report data received from server.', 'error');
      }
      
      if (!reportData.success) {
        return showStatus(reportData.message || 'Unknown error generating report.', 'error');
      }
      
      // Show the report content
      document.getElementById('product-report-content').classList.remove('hidden');
      
      // Update summary metrics
      document.getElementById('total-products').textContent = reportData.totalProducts;
      document.getElementById('total-quantity').textContent = reportData.totalQuantity;
      document.getElementById('avg-price').textContent = '$' + reportData.averagePrice.toFixed(2);
      document.getElementById('total-profit').textContent = '$' + reportData.totalProfit.toFixed(2);
      
      // Populate products table
      const tableBody = document.getElementById('products-body');
      tableBody.innerHTML = '';
      
      if (reportData.products && reportData.products.length > 0) {
        reportData.products.forEach(product => {
          const row = document.createElement('tr');
          
          row.innerHTML = `
            <td>${product.upc || 'N/A'}</td>
            <td>${product.name || 'N/A'}</td>
            <td>${product.brand || 'N/A'}</td>
            <td>${product.quantity || '0'}</td>
            <td>$${(product.price || 0).toFixed(2)}</td>
            <td>$${(product.totalSales || 0).toFixed(2)}</td>
            <td>$${(product.profit || 0).toFixed(2)}</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // Draw chart if Google Charts is loaded
        if (typeof google.charts !== 'undefined' && google.charts.loaded) {
          drawProductChart(reportData);
        } else {
          google.charts.load('current', {'packages':['corechart']});
          google.charts.setOnLoadCallback(() => drawProductChart(reportData));
        }
        
        showStatus('Product report generated successfully!', 'success');
      } else {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No products found in the selected date range.</td></tr>';
        showStatus('No products found in the selected date range.', 'info');
      }
    }

    function drawProductChart(reportData) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Product');
      data.addColumn('number', 'Sales');
      
      // Add top 10 products by sales
      const topProducts = reportData.products.slice(0, 10);
      topProducts.forEach(product => {
        data.addRow([product.name, product.totalSales]);
      });
      
      const options = {
        title: 'Top Products by Sales',
        colors: ['#FFD700'],
        backgroundColor: { fill:'transparent' },
        titleTextStyle: { color: '#FFD700' },
        legend: { textStyle: { color: '#ffffff' } },
        hAxis: { textStyle: { color: '#ffffff' } },
        vAxis: { textStyle: { color: '#ffffff' }, format: '$#,##0.00' }
      };
      
      const chart = new google.visualization.BarChart(document.getElementById('product-chart'));
      chart.draw(data, options);
    }

    function clearProductReport() {
      document.getElementById('product-report-content').classList.add('hidden');
      document.getElementById('products-body').innerHTML = '';
      hideStatus();
    }

    function exportProductReportToHTMLPDF() {
      const startDate = document.getElementById('product-start-date').value;
      const endDate = document.getElementById('product-end-date').value;
      
      showStatus('Generating PDF...', 'info');
      
      google.script.run
        .withSuccessHandler(function(pdfUrl) {
          if (pdfUrl) {
            window.open(pdfUrl, '_blank');
            showStatus('PDF generated successfully!', 'success');
            
            // Log this action
            logUserAction('Exported product performance report to PDF');
          } else {
            showStatus('Failed to generate PDF.', 'error');
          }
        })
        .withFailureHandler(onFailure)
        .exportProductReportToHTMLPDF(startDate, endDate);
    }
    // --- DISCOUNTS FUNCTIONS ---
    function loadDiscounts() {
      // Show loading indicator
      const loadingOverlay = document.getElementById('discounts-loading');
      if (loadingOverlay) {
        loadingOverlay.classList.remove('hidden');
      }
      
      // Add a safety timeout to hide the loading overlay after 10 seconds
      setTimeout(function() {
        forceHideDiscountsLoading();
        console.log("Force-hiding discounts loading overlay after timeout");
      }, 10000);
      
      console.log("Calling getDiscounts() server function...");
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("getDiscounts() returned:", result);
          
          // Hide loading indicator
          forceHideDiscountsLoading();
          
          if (!result) {
            return showStatus('No data received from server', 'error');
          }
          
          if (!result.success) {
            return showStatus(result.message || 'Error loading discounts', 'error');
          }
          
          displayDiscounts(result.discounts || []);
          populateCategoryDropdown(result.categories || []);
        })
        .withFailureHandler(function(error) {
          console.error("Error in getDiscounts():", error);
          
          // Hide loading indicator
          forceHideDiscountsLoading();
          
          showStatus('Error loading discounts: ' + error, 'error');
        })
        .getDiscounts();
    }

    function displayDiscounts(discounts) {
      console.log("displayDiscounts called with:", discounts);
      
      const tableBody = document.getElementById('discounts-body');
      if (!tableBody) {
        console.error("Could not find discounts-body element");
        return;
      }
      
      tableBody.innerHTML = '';
      
      if (!discounts || discounts.length === 0) {
        console.log("No discounts to display");
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No discounts found</td></tr>';
        return;
      }
      
      console.log("Displaying " + discounts.length + " discounts");
      
      discounts.forEach(discount => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${discount.code}</td>
          <td>${discount.type}</td>
          <td>${discount.once ? '✓' : ''}</td>
          <td>${discount.expiration}</td>
          <td>${discount.dollar ? '$' + discount.dollar : ''}</td>
          <td>${discount.percent ? discount.percent + '%' : ''}</td>
          <td>${discount.total ? '✓' : ''}</td>
          <td>${discount.category}</td>
          <td>
            <button onclick="editDiscount('${discount.code}')" class="btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Edit</button>
            <button onclick="confirmDeleteDiscount('${discount.code}')" class="btn-danger" style="padding: 5px 10px; font-size: 12px;">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      console.log("Finished displaying discounts");
    }

    function populateCategoryDropdown(categories) {
      const categorySelect = document.getElementById('discount-category');
      
      // Clear existing options except the first one
      while (categorySelect.options.length > 1) {
        categorySelect.remove(1);
      }
      
      // Add new options
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    function saveDiscount() {
      const discountData = {
        code: document.getElementById('discount-code').value,
        type: document.getElementById('discount-type').value,
        once: document.getElementById('discount-once').checked,
        expiration: document.getElementById('discount-expiration').value,
        dollar: document.getElementById('discount-dollar').value,
        percent: document.getElementById('discount-percent').value,
        total: document.getElementById('discount-total').checked,
        category: document.getElementById('discount-category').value,
        item1: document.getElementById('discount-item1').value,
        item2: document.getElementById('discount-item2').value,
        item3: document.getElementById('discount-item3').value,
        item4: document.getElementById('discount-item4').value,
        item5: document.getElementById('discount-item5').value,
        rowIndex: document.getElementById('discount-code').getAttribute('data-row-index')
      };
      
      if (!discountData.code) {
        return showStatus('Discount code is required', 'error');
      }
      
      showStatus('Saving discount...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            clearDiscountForm();
            loadDiscounts();
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error saving discount: ' + error, 'error');
        })
        .saveDiscount(discountData);
    }

    function editDiscount(code) {
      const rows = document.getElementById('discounts-body').getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        if (cells[0].textContent === code) {
          document.getElementById('discount-code').value = cells[0].textContent;
          document.getElementById('discount-code').setAttribute('data-row-index', i + 2); // +2 for header row and 1-based index
          document.getElementById('discount-type').value = cells[1].textContent;
          document.getElementById('discount-once').checked = cells[2].textContent === '✓';
          document.getElementById('discount-expiration').value = formatDateForInput(cells[3].textContent);
          document.getElementById('discount-dollar').value = cells[4].textContent.replace('$', '');
          document.getElementById('discount-percent').value = cells[5].textContent.replace('%', '');
          document.getElementById('discount-total').checked = cells[6].textContent === '✓';
          document.getElementById('discount-category').value = cells[7].textContent;
          
          // Scroll to the top of the form
          document.getElementById('discount-code').scrollIntoView();
          break;
        }
      }
    }

    function formatDateForInput(dateStr) {
      if (!dateStr) return '';
      
      try {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const month = parts[0].padStart(2, '0');
          const day = parts[1].padStart(2, '0');
          const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
          return `${year}-${month}-${day}`;
        }
      } catch (e) {
        console.error('Error formatting date:', e);
      }
      
      return '';
    }

    function clearDiscountForm() {
      document.getElementById('discount-code').value = '';
      document.getElementById('discount-code').removeAttribute('data-row-index');
      document.getElementById('discount-type').value = 'Coupon';
      document.getElementById('discount-once').checked = false;
      document.getElementById('discount-expiration').value = '';
      document.getElementById('discount-dollar').value = '';
      document.getElementById('discount-percent').value = '';
      document.getElementById('discount-total').checked = false;
      document.getElementById('discount-category').value = '';
      document.getElementById('discount-item1').value = '';
      document.getElementById('discount-item2').value = '';
      document.getElementById('discount-item3').value = '';
      document.getElementById('discount-item4').value = '';
      document.getElementById('discount-item5').value = '';
    }

    function confirmDeleteDiscount(code) {
      if (confirm(`Are you sure you want to delete discount "${code}"?`)) {
        deleteDiscount(code);
      }
    }

    function deleteDiscount(code) {
      showStatus('Deleting discount...', 'info');
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showStatus(result.message, 'success');
            loadDiscounts();
          } else {
            showStatus(result.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          showStatus('Error deleting discount: ' + error, 'error');
        })
        .deleteDiscount(code);
    }
    
    // --- UTILITY FUNCTIONS ---
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = 'block';
      
      // Auto-hide success messages after 3 seconds
      if (type === 'success') {
        setTimeout(hideStatus, 3000);
      }
    }
    
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    function onFailure(error) {
      console.error('Error:', error);
      showStatus('An error occurred: ' + error, 'error');
    }
  </script>
<script>
  // CLEAN NAVIGATION FIX WITHOUT EMERGENCY BUTTONS
  window.onload = function() {
    console.log("Navigation fix loading...");
    
    // Fix login screen layout first
    fixLoginScreenLayout();
    
    // Set up navigation
    setupNavigation();
    
    // Override login function
    overrideLoginFunction();
    
    console.log("Navigation fix loaded!");
    
    // FUNCTION DEFINITIONS
    
    // Function to fix login screen layout
    function fixLoginScreenLayout() {
      // Check if we're on the login screen
      if (!document.getElementById('login-screen').classList.contains('hidden')) {
        console.log("On login screen - hiding all main portal content");
        
        // Hide all pages
        document.querySelectorAll('.page').forEach(function(page) {
          page.style.display = 'none';
        });
        
        // Make sure main portal is hidden
        document.getElementById('main-portal').classList.add('hidden');
        document.getElementById('main-portal').style.display = 'none';
        
        // Make login screen visible
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('login-screen').style.display = 'block';
      }
    }
    
    // Function to set up navigation
    function setupNavigation() {
      console.log("Setting up navigation handlers");
      
      // Direct click handlers for categories
      document.querySelectorAll('.nav-category').forEach(function(element) {
        element.onclick = function() {
          var categoryName = this.getAttribute('data-category');
          console.log("Category clicked:", categoryName);
          
          // Update active category
          document.querySelectorAll('.nav-category').forEach(function(c) {
            c.classList.remove('active');
          });
          this.classList.add('active');
          
          // Hide all tabs
          document.querySelectorAll('.nav-tab').forEach(function(tab) {
            tab.classList.add('hidden');
          });
          
          // Show tabs for this category
          document.querySelectorAll('.nav-tab[data-category="' + categoryName + '"]').forEach(function(tab) {
            tab.classList.remove('hidden');
          });
          
          // Select first tab in this category
          var firstTab = document.querySelector('.nav-tab[data-category="' + categoryName + '"]');
          if (firstTab) {
            var pageName = firstTab.getAttribute('data-page');
            
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(function(t) {
              t.classList.remove('active');
            });
            firstTab.classList.add('active');
            
            // Update page subtitle
            document.getElementById('page-subtitle').textContent = firstTab.textContent;
            
            // Show corresponding page
            var pageId = pageName + '-page';
            document.querySelectorAll('.page').forEach(function(p) {
              p.classList.remove('active');
              p.style.display = 'none';
            });
            
            var page = document.getElementById(pageId);
            if (page) {
              page.classList.add('active');
              page.style.display = 'block';
              
              // Special handling for specific pages
              if (pageName === 'inventory-status') {
                loadInventoryStatus();
              } else if (pageName === 'expiration-tracking') {
                loadExpirationData();
              } else if (pageName === 'inventory-turnover') {
                loadTurnoverData();
              } else if (pageName === 'user-management') {
                loadUsers();
              } else if (pageName === 'credentials') {
                loadCredentials();
              } else if (pageName === 'discounts') {
                loadDiscounts();
              }
            }
          }
        };
      });
      
      // Direct click handlers for tabs
      document.querySelectorAll('.nav-tab').forEach(function(element) {
        element.onclick = function() {
          var categoryName = this.getAttribute('data-category');
          var pageName = this.getAttribute('data-page');
          console.log("Tab clicked:", categoryName, pageName);
          
          // Update active tab
          document.querySelectorAll('.nav-tab').forEach(function(t) {
            t.classList.remove('active');
          });
          this.classList.add('active');
          
          // Update page subtitle
          document.getElementById('page-subtitle').textContent = this.textContent;
          
          // Show corresponding page
          var pageId = pageName + '-page';
          document.querySelectorAll('.page').forEach(function(p) {
            p.classList.remove('active');
            p.style.display = 'none';
          });
          
          var page = document.getElementById(pageId);
          if (page) {
            page.classList.add('active');
            page.style.display = 'block';
            
            // Special handling for specific pages
            if (pageName === 'inventory-status') {
              loadInventoryStatus();
            } else if (pageName === 'expiration-tracking') {
              loadExpirationData();
            } else if (pageName === 'inventory-turnover') {
              loadTurnoverData();
            } else if (pageName === 'user-management') {
              loadUsers();
            } else if (pageName === 'credentials') {
              loadCredentials();
            } else if (pageName === 'discounts') {
              loadDiscounts();
            }
          }
        };
      });
    }
    
    // Function to override login
    function overrideLoginFunction() {
      console.log("Overriding login function");
      
      // Store original function if it exists
      var originalHandleLogin = window.handleLogin;
      
      // Override with new function
      window.handleLogin = function() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
          return showStatus('Please enter both username and password.', 'error');
        }
        
        showStatus('Logging in...', 'info');
        
        google.script.run
          .withSuccessHandler(function(isLoggedIn) {
            console.log(`Login result: ${isLoggedIn}`);
            if (isLoggedIn) {
              // Log this action
              logUserAction('Logged in');
              
              // Hide login screen
              document.getElementById('login-screen').classList.add('hidden');
              document.getElementById('login-screen').style.display = 'none';
              
              // Show main portal
              document.getElementById('main-portal').classList.remove('hidden');
              document.getElementById('main-portal').style.display = 'block';
              
              // Show active page
              const activePage = document.querySelector('.page.active');
              if (activePage) {
                activePage.style.display = 'block';
              }
              
              // Setup navigation again
              setupNavigation();
              
              hideStatus();
            } else {
              showStatus('Invalid username or password.', 'error');
            }
          })
          .withFailureHandler(function(error) {
            console.error('Login error:', error);
            showStatus('An error occurred during login: ' + error, 'error');
          })
          .checkLogin(username, password);
      };
    }
  };
</script>




</body>
</html>

